84e08bf62e46ed43c5d61618b1929341
import ErrorCatalog from './ErrorCatalog';
import ErrorLevel from './ErrorLevel';
export default class ErrorHandler {
  constructor(eventSystem = null) {
    this.eventSystem = eventSystem;
    this.errors = [];
    this.policy = {
      logLevel: ErrorLevel.WARNING,
      throwLevel: ErrorLevel.ERROR,
      emitAll: true,
      historyLimit: 100
    };
  }
  setErrorPolicy(newPolicy = {}) {
    this.policy = {
      ...this.policy,
      ...newPolicy
    };
    if (this.eventSystem) {
      this.eventSystem.emit('error.policy.change', {
        policy: this.policy
      });
    }
  }
  createError(errorCode, customMessage = null, context = {}) {
    const errorTemplate = ErrorCatalog.getErrorByCode(errorCode);
    if (!errorTemplate) {
      throw new Error(`無効なエラーコード: ${errorCode}`);
    }
    const error = {
      ...errorTemplate,
      timestamp: Date.now(),
      context: context,
      ...(customMessage && {
        message: customMessage
      })
    };
    this._handleError(error);
    return error;
  }
  _handleError(error) {
    // エラー履歴の管理
    if (this.errors.length >= this.policy.historyLimit) {
      this.errors.shift();
    }
    this.errors.push(error);

    // ログ出力
    this._logError(error);

    // イベント発火
    this._emitErrorEvent(error);

    // エラーレベルに応じて例外を投げる
    this._throwIfRequired(error);
  }
  _logError(error) {
    switch (error.level) {
      case ErrorLevel.FATAL:
        console.error('FATAL:', error);
        break;
      case ErrorLevel.ERROR:
        console.error('ERROR:', error);
        break;
      case ErrorLevel.WARNING:
        console.warn('WARNING:', error);
        break;
      case ErrorLevel.INFO:
        console.info('INFO:', error);
        break;
    }
  }
  _emitErrorEvent(error) {
    if (this.eventSystem && (this.policy.emitAll || error.level >= this.policy.logLevel)) {
      this.eventSystem.emit('error', error);
      this.eventSystem.emit(`error.${error.level}`, error);
    }
  }
  _throwIfRequired(error) {
    if (error.level >= this.policy.throwLevel) {
      throw new Error(`${error.message}: ${error.details}`);
    }
  }
  getErrorHistory(limit = null) {
    return limit ? this.errors.slice(-limit) : [...this.errors];
  }
  clearErrorHistory() {
    this.errors = [];
  }
  getErrorsByLevel(level) {
    return this.errors.filter(error => error.level === level);
  }
  convertToNativeError(errorStructure) {
    const nativeError = new Error(errorStructure.message);
    nativeError.name = 'WerewolfGameError';
    nativeError.code = errorStructure.code;
    nativeError.details = errorStructure.details;
    nativeError.context = errorStructure.context;
    return nativeError;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFcnJvckNhdGFsb2ciLCJFcnJvckxldmVsIiwiRXJyb3JIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJldmVudFN5c3RlbSIsImVycm9ycyIsInBvbGljeSIsImxvZ0xldmVsIiwiV0FSTklORyIsInRocm93TGV2ZWwiLCJFUlJPUiIsImVtaXRBbGwiLCJoaXN0b3J5TGltaXQiLCJzZXRFcnJvclBvbGljeSIsIm5ld1BvbGljeSIsImVtaXQiLCJjcmVhdGVFcnJvciIsImVycm9yQ29kZSIsImN1c3RvbU1lc3NhZ2UiLCJjb250ZXh0IiwiZXJyb3JUZW1wbGF0ZSIsImdldEVycm9yQnlDb2RlIiwiRXJyb3IiLCJlcnJvciIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJtZXNzYWdlIiwiX2hhbmRsZUVycm9yIiwibGVuZ3RoIiwic2hpZnQiLCJwdXNoIiwiX2xvZ0Vycm9yIiwiX2VtaXRFcnJvckV2ZW50IiwiX3Rocm93SWZSZXF1aXJlZCIsImxldmVsIiwiRkFUQUwiLCJjb25zb2xlIiwid2FybiIsIklORk8iLCJpbmZvIiwiZGV0YWlscyIsImdldEVycm9ySGlzdG9yeSIsImxpbWl0Iiwic2xpY2UiLCJjbGVhckVycm9ySGlzdG9yeSIsImdldEVycm9yc0J5TGV2ZWwiLCJmaWx0ZXIiLCJjb252ZXJ0VG9OYXRpdmVFcnJvciIsImVycm9yU3RydWN0dXJlIiwibmF0aXZlRXJyb3IiLCJuYW1lIiwiY29kZSJdLCJzb3VyY2VzIjpbIkVycm9ySGFuZGxlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRXJyb3JDYXRhbG9nIGZyb20gJy4vRXJyb3JDYXRhbG9nJztcbmltcG9ydCBFcnJvckxldmVsIGZyb20gJy4vRXJyb3JMZXZlbCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVycm9ySGFuZGxlciB7XG4gIGNvbnN0cnVjdG9yKGV2ZW50U3lzdGVtID0gbnVsbCkge1xuICAgIHRoaXMuZXZlbnRTeXN0ZW0gPSBldmVudFN5c3RlbTtcbiAgICB0aGlzLmVycm9ycyA9IFtdO1xuICAgIHRoaXMucG9saWN5ID0ge1xuICAgICAgbG9nTGV2ZWw6IEVycm9yTGV2ZWwuV0FSTklORyxcbiAgICAgIHRocm93TGV2ZWw6IEVycm9yTGV2ZWwuRVJST1IsXG4gICAgICBlbWl0QWxsOiB0cnVlLFxuICAgICAgaGlzdG9yeUxpbWl0OiAxMDBcbiAgICB9O1xuICB9XG5cbiAgc2V0RXJyb3JQb2xpY3kobmV3UG9saWN5ID0ge30pIHtcbiAgICB0aGlzLnBvbGljeSA9IHsgLi4udGhpcy5wb2xpY3ksIC4uLm5ld1BvbGljeSB9O1xuICAgIFxuICAgIGlmICh0aGlzLmV2ZW50U3lzdGVtKSB7XG4gICAgICB0aGlzLmV2ZW50U3lzdGVtLmVtaXQoJ2Vycm9yLnBvbGljeS5jaGFuZ2UnLCB7IHBvbGljeTogdGhpcy5wb2xpY3kgfSk7XG4gICAgfVxuICB9XG5cbiAgY3JlYXRlRXJyb3IoZXJyb3JDb2RlLCBjdXN0b21NZXNzYWdlID0gbnVsbCwgY29udGV4dCA9IHt9KSB7XG4gICAgY29uc3QgZXJyb3JUZW1wbGF0ZSA9IEVycm9yQ2F0YWxvZy5nZXRFcnJvckJ5Q29kZShlcnJvckNvZGUpO1xuICAgIGlmICghZXJyb3JUZW1wbGF0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGDnhKHlirnjgarjgqjjg6njg7zjgrPjg7zjg4k6ICR7ZXJyb3JDb2RlfWApO1xuICAgIH1cblxuICAgIGNvbnN0IGVycm9yID0ge1xuICAgICAgLi4uZXJyb3JUZW1wbGF0ZSxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIGNvbnRleHQ6IGNvbnRleHQsXG4gICAgICAuLi4oY3VzdG9tTWVzc2FnZSAmJiB7IG1lc3NhZ2U6IGN1c3RvbU1lc3NhZ2UgfSlcbiAgICB9O1xuXG4gICAgdGhpcy5faGFuZGxlRXJyb3IoZXJyb3IpO1xuICAgIHJldHVybiBlcnJvcjtcbiAgfVxuXG4gIF9oYW5kbGVFcnJvcihlcnJvcikge1xuICAgIC8vIOOCqOODqeODvOWxpeattOOBrueuoeeQhlxuICAgIGlmICh0aGlzLmVycm9ycy5sZW5ndGggPj0gdGhpcy5wb2xpY3kuaGlzdG9yeUxpbWl0KSB7XG4gICAgICB0aGlzLmVycm9ycy5zaGlmdCgpO1xuICAgIH1cbiAgICB0aGlzLmVycm9ycy5wdXNoKGVycm9yKTtcblxuICAgIC8vIOODreOCsOWHuuWKm1xuICAgIHRoaXMuX2xvZ0Vycm9yKGVycm9yKTtcblxuICAgIC8vIOOCpOODmeODs+ODiOeZuueBq1xuICAgIHRoaXMuX2VtaXRFcnJvckV2ZW50KGVycm9yKTtcblxuICAgIC8vIOOCqOODqeODvOODrOODmeODq+OBq+W/nOOBmOOBpuS+i+WkluOCkuaKleOBkuOCi1xuICAgIHRoaXMuX3Rocm93SWZSZXF1aXJlZChlcnJvcik7XG4gIH1cblxuICBfbG9nRXJyb3IoZXJyb3IpIHtcbiAgICBzd2l0Y2ggKGVycm9yLmxldmVsKSB7XG4gICAgICBjYXNlIEVycm9yTGV2ZWwuRkFUQUw6XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZBVEFMOicsIGVycm9yKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEVycm9yTGV2ZWwuRVJST1I6XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0VSUk9SOicsIGVycm9yKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEVycm9yTGV2ZWwuV0FSTklORzpcbiAgICAgICAgY29uc29sZS53YXJuKCdXQVJOSU5HOicsIGVycm9yKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEVycm9yTGV2ZWwuSU5GTzpcbiAgICAgICAgY29uc29sZS5pbmZvKCdJTkZPOicsIGVycm9yKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgX2VtaXRFcnJvckV2ZW50KGVycm9yKSB7XG4gICAgaWYgKHRoaXMuZXZlbnRTeXN0ZW0gJiYgKHRoaXMucG9saWN5LmVtaXRBbGwgfHwgZXJyb3IubGV2ZWwgPj0gdGhpcy5wb2xpY3kubG9nTGV2ZWwpKSB7XG4gICAgICB0aGlzLmV2ZW50U3lzdGVtLmVtaXQoJ2Vycm9yJywgZXJyb3IpO1xuICAgICAgdGhpcy5ldmVudFN5c3RlbS5lbWl0KGBlcnJvci4ke2Vycm9yLmxldmVsfWAsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBfdGhyb3dJZlJlcXVpcmVkKGVycm9yKSB7XG4gICAgaWYgKGVycm9yLmxldmVsID49IHRoaXMucG9saWN5LnRocm93TGV2ZWwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHtlcnJvci5tZXNzYWdlfTogJHtlcnJvci5kZXRhaWxzfWApO1xuICAgIH1cbiAgfVxuXG4gIGdldEVycm9ySGlzdG9yeShsaW1pdCA9IG51bGwpIHtcbiAgICByZXR1cm4gbGltaXQgPyB0aGlzLmVycm9ycy5zbGljZSgtbGltaXQpIDogWy4uLnRoaXMuZXJyb3JzXTtcbiAgfVxuXG4gIGNsZWFyRXJyb3JIaXN0b3J5KCkge1xuICAgIHRoaXMuZXJyb3JzID0gW107XG4gIH1cblxuICBnZXRFcnJvcnNCeUxldmVsKGxldmVsKSB7XG4gICAgcmV0dXJuIHRoaXMuZXJyb3JzLmZpbHRlcihlcnJvciA9PiBlcnJvci5sZXZlbCA9PT0gbGV2ZWwpO1xuICB9XG5cbiAgY29udmVydFRvTmF0aXZlRXJyb3IoZXJyb3JTdHJ1Y3R1cmUpIHtcbiAgICBjb25zdCBuYXRpdmVFcnJvciA9IG5ldyBFcnJvcihlcnJvclN0cnVjdHVyZS5tZXNzYWdlKTtcbiAgICBuYXRpdmVFcnJvci5uYW1lID0gJ1dlcmV3b2xmR2FtZUVycm9yJztcbiAgICBuYXRpdmVFcnJvci5jb2RlID0gZXJyb3JTdHJ1Y3R1cmUuY29kZTtcbiAgICBuYXRpdmVFcnJvci5kZXRhaWxzID0gZXJyb3JTdHJ1Y3R1cmUuZGV0YWlscztcbiAgICBuYXRpdmVFcnJvci5jb250ZXh0ID0gZXJyb3JTdHJ1Y3R1cmUuY29udGV4dDtcbiAgICByZXR1cm4gbmF0aXZlRXJyb3I7XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6IkFBQUEsT0FBT0EsWUFBWSxNQUFNLGdCQUFnQjtBQUN6QyxPQUFPQyxV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LENBQUNFLE1BQU0sQ0FBQ0ssT0FBTyxJQUFJWSxLQUFLLENBQUNZLEtBQUssSUFBSSxJQUFJLENBQUM3QixNQUFNLENBQUNDLFFBQVEsQ0FBQyxFQUFFO01BQ3BGLElBQUksQ0FBQ0gsV0FBVyxDQUFDVyxJQUFJLENBQUMsT0FBTyxFQUFFUSxLQUFLLENBQUM7TUFDckMsSUFBSSxDQUFDbkIsV0FBVyxDQUFDVyxJQUFJLENBQUMsU0FBU1EsS0FBSyxDQUFDWSxLQUFLLEVBQUUsRUFBRVosS0FBSyxDQUFDO0lBQ3REO0VBQ0Y7RUFFQVcsZ0JBQWdCQSxDQUFDWCxLQUFLLEVBQUU7SUFDdEIsSUFBSUEsS0FBSyxDQUFDWSxLQUFLLElBQUksSUFBSSxDQUFDN0IsTUFBTSxDQUFDRyxVQUFVLEVBQUU7TUFDekMsTUFBTSxJQUFJYSxLQUFLLENBQUMsR0FBR0MsS0FBSyxDQUFDSSxPQUFPLEtBQUtKLEtBQUssQ0FBQ2tCLE9BQU8sRUFBRSxDQUFDO0lBQ3ZEO0VBQ0Y7RUFFQUMsZUFBZUEsQ0FBQ0MsS0FBSyxHQUFHLElBQUksRUFBRTtJQUM1QixPQUFPQSxLQUFLLEdBQUcsSUFBSSxDQUFDdEMsTUFBTSxDQUFDdUMsS0FBSyxDQUFDLENBQUNELEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUN0QyxNQUFNLENBQUM7RUFDN0Q7RUFFQXdDLGlCQUFpQkEsQ0FBQSxFQUFHO0lBQ2xCLElBQUksQ0FBQ3hDLE1BQU0sR0FBRyxFQUFFO0VBQ2xCO0VBRUF5QyxnQkFBZ0JBLENBQUNYLEtBQUssRUFBRTtJQUN0QixPQUFPLElBQUksQ0FBQzlCLE1BQU0sQ0FBQzBDLE1BQU0sQ0FBQ3hCLEtBQUssSUFBSUEsS0FBSyxDQUFDWSxLQUFLLEtBQUtBLEtBQUssQ0FBQztFQUMzRDtFQUVBYSxvQkFBb0JBLENBQUNDLGNBQWMsRUFBRTtJQUNuQyxNQUFNQyxXQUFXLEdBQUcsSUFBSTVCLEtBQUssQ0FBQzJCLGNBQWMsQ0FBQ3RCLE9BQU8sQ0FBQztJQUNyRHVCLFdBQVcsQ0FBQ0MsSUFBSSxHQUFHLG1CQUFtQjtJQUN0Q0QsV0FBVyxDQUFDRSxJQUFJLEdBQUdILGNBQWMsQ0FBQ0csSUFBSTtJQUN0Q0YsV0FBVyxDQUFDVCxPQUFPLEdBQUdRLGNBQWMsQ0FBQ1IsT0FBTztJQUM1Q1MsV0FBVyxDQUFDL0IsT0FBTyxHQUFHOEIsY0FBYyxDQUFDOUIsT0FBTztJQUM1QyxPQUFPK0IsV0FBVztFQUNwQjtBQUNGIiwiaWdub3JlTGlzdCI6W119