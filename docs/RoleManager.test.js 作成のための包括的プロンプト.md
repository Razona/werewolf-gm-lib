# RoleManager.test.js 作成プロンプト（強化版）

## 目的
RoleManager.jsの実装に先立って、テストファイルを作成します。このテストはTest-Driven Development (TDD)アプローチを使用し、RoleManagerの機能を明確にすると同時に、実装ガイドとしても機能します。

## テストファイルの配置先
```
/Users/RazonaMAC/Desktop/Razona/PROGRAMING/node.js/werewolf-gm-lib/src/domain/role/__tests__/RoleManager.test.js
```

## テストの範囲
以下の機能をテストする必要があります：

1. **初期化と基本セットアップ**: イベントシステムやエラーハンドラとの統合
2. **役職の登録と管理**: 役職クラスの登録、取得、検証
3. **役職と陣営の追加と削除**: registerRole、unregisterRole、hasRole、getRegisteredRoles
4. **プレイヤーへの役職割り当て**: assignRole、getPlayerRole、getRolesByPlayerId
5. **役職の一括配布**: distributeRoles（複数プレイヤーへのランダム割り当て）
6. **役職の検証**: validateRoleDependencies、validateRoleBalance、validateRoleCompatibility
7. **役職ライフサイクル管理**: triggerRoleLifecycleMethod、notifyGameStart、notifyPhaseChange
8. **役職間の相互参照**: setupRoleReferences（人狼間、共有者間、妖狐と背徳者間）
9. **陣営管理**: getTeamsWinStatus、registerTeam、getTeam、getTeamInfo
10. **役職情報と視点管理**: getRoleInfo、getVisibleRoles、setVisibilityRules
11. **特殊イベント処理**: handlePlayerDeath、handleTargetedAction

## 構造
他のテストファイルの構造に合わせて、以下のような形式で実装します：

1. 最初のセクションでモックを定義
2. beforeEach内でテスト環境をリセット
3. 機能別に入れ子のdescribeブロックでテストを分類
4. 各テストは特定の機能の検証に焦点を当てる
5. エラーケースも明示的にテスト

## モック対象
以下の依存コンポーネントをモックします：

1. EventSystem (emit, on メソッド)
2. ErrorHandler (handleError メソッド)
3. PlayerManager (プレイヤー関連メソッド)
4. 乱数生成器 (シード固定のためのrandom関数)
5. Game (ゲーム全体の参照)

## テスト戦略
以下の戦略でテストを作成します：

1. **単体テスト**: 各メソッドの機能を個別にテスト
2. **統合テスト**: 複数のメソッドの連携を確認
3. **エッジケース**: 異常系の処理を確認
4. **役職間の相互作用**: 役職の複雑な相互関係をテスト
5. **イベント発火**: 適切なイベントが正しいタイミングで発火されることを確認

## ポイント
新しく実装するRoleManagerのテストなので、以下の点に注意します：

1. **クラスの責務を明確に**: テストを通してRoleManagerの責務を定義する
2. **インターフェースの設計**: メソッドの引数や戻り値の形式を明確にする
3. **エラー処理**: エラーケースと例外処理を明確に定義する
4. **依存関係**: 他のモジュールとの関係を明確にする
5. **拡張ポイント**: カスタム役職や陣営を追加するための拡張機能をテスト
6. **イベント連携**: 適切なイベントが発火されることを確認

## テストヘルパー関数の推奨
テストの重複を減らすために、以下のようなヘルパー関数を定義することを推奨します：

1. **基本的なRoleManagerインスタンスを作成するヘルパー**
   - 引数として EventSystem, ErrorHandler, Random を受け取る
   - 戻り値として初期化されたRoleManagerインスタンスを返す

2. **標準的な役職を登録するヘルパー**
   - 引数として RoleManager インスタンスを受け取る
   - 標準役職（村人、人狼、占い師など）を登録
   - 戻り値として同じRoleManagerインスタンスを返す

3. **テスト用の役職配布設定を行うヘルパー**
   - 引数としてプレイヤーIDリストと役職リストを受け取る
   - RoleManagerインスタンスを作成・初期化し、標準役職を登録
   - mockEventEmitなどのモックをクリア
   - 戻り値として設定されたRoleManagerと各種パラメータを含むオブジェクトを返す

4. **役職の相互参照テスト用ヘルパー**
   - 引数として役職の割り当て情報（プレイヤーIDと役職名のペアのリスト）を受け取る
   - RoleManagerインスタンスを作成・初期化し、標準役職を登録
   - 指定された役職割り当てを実行
   - mockEventEmitなどのモックをクリア
   - 戻り値として設定されたRoleManagerを返す

## 各機能のテスト設計ガイドライン

### 1. 初期化と基本セットアップ
- イベントシステムとエラーハンドラが正しく設定されているか
- イベントリスナーが適切に登録されているか
- 乱数生成器が適切に設定されているか
- デフォルトの可視性ルールが設定されているか
- 標準陣営（村人陣営、人狼陣営、第三陣営）が登録されているか

### 2. 役職の登録と管理
- 役職の登録が成功するか
- 重複した役職の登録で適切なエラーが発生するか
- 無効な役職クラス（Role基底クラスを継承していない）の登録で適切なエラーが発生するか
- 役職の登録解除が成功するか
- 登録済み役職の確認ができるか
- 登録済み役職名の一覧が取得できるか
- 複数の役職を一括で登録できるか

### 3. 役職インスタンス化
- 役職インスタンスが正しく生成されるか
- 存在しない役職のインスタンス化で適切なエラーが発生するか
- 役職インスタンスがキャッシュされ再利用されるか
- 役職インスタンスにゲーム参照が正しく設定されるか
- 役職インスタンスのプロパティが適切に初期化されるか

### 4. プレイヤーへの役職割り当て
- プレイヤーに役職を割り当てられるか
- 役職割り当て時に適切なイベントが発火されるか
- 存在しない役職の割り当てで適切なエラーが発生するか
- プレイヤーの役職情報を取得できるか
- 役職が割り当てられていないプレイヤーの役職取得で適切な値（null）が返るか
- 既に役職が割り当てられているプレイヤーに別の役職を割り当てる際の動作が適切か

### 5. 役職の一括配布
- 複数プレイヤーへの役職一括配布が成功するか
- プレイヤー数と役職数が一致しない場合に適切なエラーが発生するか
- シャッフルオプションが正しく機能するか
- シード値を指定した場合に再現性のある配布が行われるか
- 役職の依存関係を考慮した配布が行われるか
- 配布結果が適切なフォーマットで返されるか
- 配布に関する適切なイベントが発火されるか

### 6. 役職の検証
- 役職の依存関係チェック（validateRoleDependencies）が正しく機能するか
- 役職バランスのチェック（validateRoleBalance）が正しく機能するか
- 役職の互換性チェック（validateRoleCompatibility）が正しく機能するか
- 依存役職が存在しない場合に適切なエラーが発生するか
- 役職バランスが不適切な場合に適切なエラーが発生するか
- 互換性のない役職の組み合わせで適切なエラーが発生するか

### 7. 役職ライフサイクル管理
- 全役職に対してライフサイクルメソッドを一括で呼び出せるか
- ゲーム開始通知（notifyGameStart）で全役職のonGameStartが呼ばれるか
- フェーズ変更通知（notifyPhaseChange）で全役職のonPhaseStartが呼ばれるか
- ターン終了通知（notifyTurnEnd）で全役職のonTurnEndが呼ばれるか
- ライフサイクルメソッドの実行結果が適切に集約されるか
- ライフサイクルメソッド実行時のエラーが適切に処理されるか

### 8. 役職間の相互参照
- 役職間の相互参照設定（setupRoleReferences）が正しく機能するか
- 人狼同士が互いを認識できるようになるか
- 共有者同士が互いを認識できるようになるか
- 背徳者が妖狐を認識できるようになるか
- 相互参照設定に関する適切なイベントが発火されるか
- 相互参照が必要な役職が存在しない場合のエラー処理が適切か

### 9. 陣営管理
- 新しい陣営を登録できるか
- 陣営情報を取得できるか
- 各陣営の勝利状態を確認できるか
- 標準陣営（村人陣営、人狼陣営、第三陣営）が正しく管理されるか
- 陣営登録に関する適切なイベントが発火されるか
- 存在しない陣営の取得で適切なエラーが発生するか

### 10. 役職情報と視点管理
- 役職情報を取得できるか
- 視点に基づいて適切にフィルタリングされた役職情報が返されるか
- 可視性ルールを設定できるか
- 死亡プレイヤーの役職表示に関するルールが適用されるか
- 特殊な役職関係（人狼同士、共有者同士など）での情報共有が適切に行われるか
- GMが全ての役職情報を見られるか

### 11. 特殊イベント処理
- プレイヤー死亡イベント（handlePlayerDeath）が適切に処理されるか
- 役職能力対象イベント（handleTargetedAction）が適切に処理されるか
- フェーズ開始イベントで適切な役職能力が有効化されるか
- ゲーム開始イベントで役職の初期化が行われるか
- 特殊イベント処理で適切な役職メソッドが呼ばれるか
- イベント処理中のエラーが適切に処理されるか

## 境界ケースとエラー状況

以下のような境界ケースや異常系も必ずテストしてください：

1. **役職依存関係の検証**
   - 背徳者が存在するが妖狐が存在しない場合
   - 必須役職（人狼など）が含まれていない場合

2. **役職バランスの検証**
   - 人狼の数が多すぎる場合
   - 村人が少なすぎる場合
   - 第三陣営の役職が多すぎる場合

3. **役職割り当ての異常系**
   - 存在しないプレイヤーへの割り当て
   - 存在しない役職の割り当て
   - 死亡したプレイヤーへの割り当て

4. **同一インスタンスの再利用保証**
   - 同じ役職名で複数回インスタンス化を試みた場合

5. **役職配布の境界条件**
   - プレイヤー数と役職数が一致しない場合
   - 空の役職リストで配布を試みた場合
   - 無効な役職を含む役職リストの場合

6. **役職ライフサイクルの異常処理**
   - 役職のライフサイクルメソッド実行時にエラーが発生した場合
   - 一部の役職にライフサイクルメソッドが実装されていない場合

7. **相互参照の検証**
   - 相互参照設定時に一部の役職が存在しない場合
   - 相互参照が必要ない単一の役職しか存在しない場合

8. **陣営管理のエラー処理**
   - 既に存在する陣営を再登録しようとした場合
   - 無効な陣営情報での登録

9. **情報開示の複雑なパターン**
   - 死亡プレイヤーが全役職情報を見られる設定の場合
   - 特定の役職間でのみ情報共有がある場合
   - GMモードでの情報開示

10. **イベント連携の確実な検証**
    - イベントハンドラの登録と削除が適切に行われるか
    - 複数のイベントが連鎖的に発生する場合の処理

## Jest特有の機能の活用

1. **Jest.spyOn**を使用してメソッド呼び出しを監視
2. **toHaveBeenCalledWith**などの具体的なマッチャーを活用
3. **expect.objectContaining**を使用して部分的なオブジェクト一致を検証
4. **beforeEach**と**afterEach**で適切なセットアップとクリーンアップ
5. **describe.each**を使用して類似したテストケースをパラメータ化

## モックの高度な活用

1. **PlayerManagerのモック**をより詳細に：
   - mockPlayerManagerにはgetAlivePlayers、getPlayer、getAllPlayersだけでなく、より具体的なメソッドをモック
   - テストに応じて動的にモックの振る舞いを変更できるように設計

2. **RoleインスタンスのSpy**:
   - 生成されたRoleインスタンスのメソッド呼び出しを監視
   - 特にライフサイクルメソッドの呼び出しを検証

3. **イベントのモック**:
   - より詳細なイベントハンドラ登録のテスト
   - イベント発火の順序と内容の検証

これらのガイドラインに従って、RoleManagerの機能を網羅的にテストするコードを作成してください。