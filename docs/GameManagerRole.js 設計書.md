# GameManagerRole.js 設計書

## 1. 概要

`GameManagerRole.js` はGameManagerの役職管理機能を提供するモジュールです。役職の設定、配布、割り当て、情報取得など、役職に関連する操作を担当します。このモジュールは、イベント駆動型アーキテクチャを採用し、他のモジュールとの連携を効率化します。

## 2. 役割と責務

- 使用する役職リストの設定と検証
- プレイヤーへの役職割り当てと配布
- 役職情報の取得と視点に基づいた情報フィルタリング
- チーム/陣営情報の管理と提供
- 役職関連のイベント処理と状態管理
- カスタム役職の登録と管理
- 役職の依存関係と組み合わせの検証

## 3. 依存モジュール

このファイルはGameManagerのMix-inとして実装され、以下のモジュールと連携します：

- **RoleManager**: 役職の詳細管理と役職間の相互作用
- **PlayerManager**: プレイヤー情報との連携
- **EventSystem**: イベントの発火と購読
- **ErrorHandler**: エラー処理と検証
- **Common/Utils**: 共通ユーティリティ関数

## 4. Mix-in関数の定義

GameManagerのプロトタイプに以下のメソッドを追加します：

### 4.1 役職設定と割り当て

#### setRoles(roleList)
**説明**: 使用する役職リストを設定します。  
**アクセス**: public  
**パラメータ**:
- roleList: 役職名の配列（'villager', 'werewolf'など）  
**戻り値**: 設定成功時にtrue  
**処理内容**:
- ゲーム開始状態の検証（開始前のみ許可）
- 役職リストの構造と内容の検証
- 役職リスト設定前イベントの発火
- RoleManagerへの役職リスト設定委譲
- 役職リスト設定後イベントの発火
- エラー処理

#### distributeRoles(options)
**説明**: 役職をプレイヤーに配布します。  
**アクセス**: public  
**パラメータ**:
- options: 配布オプション
  - shuffle: 役職をシャッフルするかどうか（デフォルト: true）
  - customDistribution: カスタム配布アルゴリズム（オプション）
  - seed: 乱数シード値（再現性確保用、オプション）  
**戻り値**: プレイヤーIDと割り当てられた役職のマッピング  
**処理内容**:
- ゲーム開始状態の検証
- プレイヤー数と役職数のバランス検証
- 役職配布前イベントの発火
- 配布オプションの処理と適用
- RoleManagerへの役職配布処理委譲
- 各プレイヤーへの役職割り当て実行
- 役職配布後イベントの発火
- 役職間の相互参照設定
- 配布結果の返却
- エラー処理

#### assignRole(playerId, roleName)
**説明**: 特定の役職を特定のプレイヤーに割り当てます。  
**アクセス**: public  
**パラメータ**:
- playerId: プレイヤーID
- roleName: 役職名  
**戻り値**: 割り当て成功時にtrue  
**処理内容**:
- ゲーム開始状態の検証
- プレイヤーと役職の存在確認
- 現在の役職割り当て状態の確認（再割り当ての場合）
- 役職割り当て前イベントの発火
- RoleManagerへの役職割り当て委譲
- 役職割り当て後イベントの発火
- エラー処理

### 4.2 役職情報の取得

#### getRoleInfo(playerId, viewerId)
**説明**: プレイヤーの役職情報を取得します。視点に基づいた情報フィルタリングを適用します。  
**アクセス**: public  
**パラメータ**:
- playerId: 情報を取得するプレイヤーID
- viewerId: 情報を見るプレイヤーID（デフォルト: null = GM視点）  
**戻り値**: 役職情報オブジェクト（視点に基づきフィルタリング済み）  
**処理内容**:
- プレイヤー存在確認
- 視点に基づく情報フィルタリング適用
  - 自分自身の役職は常に完全に見える
  - 人狼は他の人狼を認識できる
  - 共有者は他の共有者を認識できる
  - 妖狐は背徳者を認識できる（レギュレーションによる）
  - 背徳者は妖狐を認識できる
  - 死亡プレイヤーの役職は設定により公開される場合がある
- RoleManagerからの役職情報取得
- レギュレーションに基づいた情報制限の適用
- エラー処理

#### getRoleName(playerId)
**説明**: プレイヤーの役職名を取得します。  
**アクセス**: public  
**パラメータ**:
- playerId: プレイヤーID  
**戻り値**: 役職名  
**処理内容**:
- 役職情報から役職名を抽出
- エラー処理

#### getPlayerTeam(playerId)
**説明**: プレイヤーの所属陣営を取得します。  
**アクセス**: public  
**パラメータ**:
- playerId: プレイヤーID  
**戻り値**: 陣営名（'village', 'werewolf', 'fox'など）  
**処理内容**:
- 役職情報から陣営を抽出
- エラー処理

#### getDisplayRoleName(playerId, viewerId)
**説明**: 表示用の役職名を取得します。視点によって表示内容が変わることがあります。  
**アクセス**: public  
**パラメータ**:
- playerId: プレイヤーID
- viewerId: 視点となるプレイヤーID（デフォルト: null = GM視点）  
**戻り値**: 表示用役職名  
**処理内容**:
- 役職情報と視点に基づいた表示名の生成
- レギュレーションと状態に基づく表示制御
- エラー処理

### 4.3 役職グループ操作

#### getPlayersByRole(roleName)
**説明**: 特定の役職を持つプレイヤーを取得します。  
**アクセス**: public  
**パラメータ**:
- roleName: 役職名  
**戻り値**: 該当するプレイヤーIDの配列  
**処理内容**:
- RoleManagerから該当プレイヤー情報取得
- エラー処理

#### getPlayersByTeam(team)
**説明**: 特定の陣営に属するプレイヤーを取得します。  
**アクセス**: public  
**パラメータ**:
- team: 陣営名  
**戻り値**: 該当するプレイヤーIDの配列  
**処理内容**:
- RoleManagerから該当プレイヤー情報取得
- エラー処理

#### areAllRolesAssigned()
**説明**: すべてのプレイヤーに役職が割り当てられているかを確認します。  
**アクセス**: public  
**戻り値**: すべてのプレイヤーに役職が割り当てられていればtrue  
**処理内容**:
- 全プレイヤーの役職割り当て状況確認
- エラー処理

### 4.4 役職能力関連

#### getFortuneResult(targetId)
**説明**: 占い結果を取得します。  
**アクセス**: public  
**パラメータ**:
- targetId: 占い対象のプレイヤーID  
**戻り値**: 占い結果（'village', 'werewolf'など）  
**処理内容**:
- プレイヤー存在確認
- RoleManagerからの占い結果取得
- レギュレーションによる結果修正（初日ランダム白など）
- エラー処理

#### getMediumResult(targetId)
**説明**: 霊媒結果を取得します。  
**アクセス**: public  
**パラメータ**:
- targetId: 霊媒対象のプレイヤーID  
**戻り値**: 霊媒結果（'village', 'werewolf'など）  
**処理内容**:
- プレイヤーが死亡しているか確認
- RoleManagerからの霊媒結果取得
- エラー処理

#### canUseAbility(playerId, ability, context)
**説明**: プレイヤーが特定の能力を使用できるかどうかを確認します。  
**アクセス**: public  
**パラメータ**:
- playerId: プレイヤーID
- ability: 能力識別子
- context: 使用コンテキスト（夜番号など）  
**戻り値**: 使用可否情報  
**処理内容**:
- プレイヤー生存確認
- 役職と能力の対応確認
- RoleManagerへの能力使用可否確認の委譲
- レギュレーション（連続ガード禁止など）に基づく制約確認
- エラー処理

### 4.5 拡張機能

#### registerRole(roleName, roleClass)
**説明**: カスタム役職を登録します。  
**アクセス**: public  
**パラメータ**:
- roleName: 役職名
- roleClass: 役職クラス  
**戻り値**: 登録成功時にtrue  
**処理内容**:
- ゲーム開始状態の検証
- 役職クラスの基本検証
- カスタム役職登録前イベントの発火
- RoleManagerへの役職登録委譲
- カスタム役職登録後イベントの発火
- エラー処理

#### getVisibleRoleInfo(playerId, viewerId)
**説明**: 視点に基づいてフィルタリングされた役職情報を取得します。  
**アクセス**: public  
**パラメータ**:
- playerId: 情報を取得するプレイヤーID
- viewerId: 視点となるプレイヤーID  
**戻り値**: フィルタリングされた役職情報  
**処理内容**:
- 情報公開度の計算
- 視点に基づいた情報フィルタリング
- 情報マスキング処理
- エラー処理

### 4.6 内部ヘルパーメソッド

#### _validateRoleList(roleList)
**説明**: 役職リストの妥当性を検証します。  
**アクセス**: private  
**パラメータ**:
- roleList: 検証する役職リスト  
**戻り値**: 検証結果と問題点  
**処理内容**:
- 役職名の妥当性チェック
- 役職構成のバランス検証
- 役職の依存関係チェック
- 役職の互換性確認

#### _setupRoleReferences()
**説明**: 役職間の相互参照を設定します。  
**アクセス**: private  
**処理内容**:
- 共有者同士の相互参照設定
- 人狼同士の相互参照設定
- 妖狐と背徳者の相互参照設定
- その他の役職関連性設定

#### _isRoleInfoVisible(fromPlayerId, toPlayerId)
**説明**: あるプレイヤーの役職情報が別のプレイヤーから見えるかどうかを判定します。  
**アクセス**: private  
**パラメータ**:
- fromPlayerId: 情報元プレイヤーID
- toPlayerId: 視点となるプレイヤーID  
**戻り値**: 可視性レベル  
**処理内容**:
- 同一プレイヤーのチェック（自分の役職は常に見える）
- 役職に基づく可視性ルール適用
- レギュレーションに基づく可視性ルール適用
- ゲーム状態（死亡状態など）に基づく可視性判定

## 5. 設計上の注意点

### 5.1 状態一貫性の確保

- **原則としてゲーム開始前のみ操作可能**:
  - 役職設定、配布、割り当ては原則としてゲーム開始前のみ許可
  - ゲーム進行中の役職変更は通常許可しない（特殊役職効果を除く）

- **トランザクショナルな役職配布**:
  - 役職配布は全て成功するか全て失敗するかの一貫性を保証
  - 部分的な割り当て状態を避ける設計

- **イベント駆動による状態変更通知**:
  - 役職関連の全ての状態変更はイベントとして発火
  - 前後のイベント（before/after）を提供し拡張性を確保

### 5.2 非対称情報の管理

- **視点管理の仕組み**:
  - どのプレイヤーがどの情報を見られるかを厳密に管理
  - GMは全ての情報を見られるが、プレイヤーは限定的な情報のみアクセス可能

- **役職による情報共有ルール**:
  - 同じ役職グループ間での情報共有（人狼同士、共有者同士）
  - 関連役職間の情報共有（妖狐と背徳者）
  - 役職公開設定（死亡時の役職公開など）に基づく情報提供

- **情報漏洩の防止**:
  - 不正な情報アクセスを防止するための厳格な検証
  - 情報のマスキングと適切なフィルタリング

### 5.3 パフォーマンス最適化

- **キャッシング戦略**:
  - 頻繁にアクセスされる役職情報のキャッシング
  - 役職グループ（同じ役職を持つプレイヤーリストなど）のキャッシュ

- **必要最小限の計算**:
  - 役職情報の不必要な再計算を避ける設計
  - オンデマンドで情報を計算するアプローチ

- **大規模ゲームへの対応**:
  - 多数のプレイヤー・役職を扱う場合の最適化
  - 検索操作の効率化（インデックス活用など）

### 5.4 拡張性の確保

- **カスタム役職の柔軟な登録**:
  - プラグインシステムとの連携
  - 標準インターフェースによる役職拡張

- **レギュレーション連携**:
  - 様々なレギュレーションに対応可能な柔軟な設計
  - レギュレーション変更への適応メカニズム

- **役職バランス検証の拡張性**:
  - カスタム検証ルールの追加をサポート
  - 既存検証ルールのオーバーライド機能

- **シリアライズと永続化**:
  - 役職状態の保存と復元を容易にする設計
  - 保存データの前方/後方互換性の確保

## 6. イベントリスト

役職管理に関連する主要イベント：

| イベント名 | 発火タイミング | データ内容 |
|------------|----------------|------------|
| `role.list.set.before` | 役職リスト設定前 | `{roleList}` |
| `role.list.set.after` | 役職リスト設定後 | `{roleList, success}` |
| `role.distribution.before` | 役職配布前 | `{playerCount, roleCount, options}` |
| `role.distribution.after` | 役職配布後 | `{distribution, success}` |
| `role.assigned.before` | 役職割り当て前 | `{playerId, roleName, previous}` |
| `role.assigned.after` | 役職割り当て後 | `{playerId, roleName, success}` |
| `role.reference.setup` | 役職間の相互参照設定時 | `{references}` |
| `role.ability.check` | 役職能力使用可否確認時 | `{playerId, ability, context, result}` |
| `role.info.access` | 役職情報アクセス時 | `{targetId, viewerId, level}` |
| `role.revealed` | 役職公開時 | `{playerId, roleName, cause}` |
| `role.custom.register.before` | カスタム役職登録前 | `{roleName, roleClass}` |
| `role.custom.register.after` | カスタム役職登録後 | `{roleName, success}` |

## 7. エラー処理

役職管理に関連する主要エラー：

| エラーコード | メッセージ例 | 説明 |
|------------|----------------|------------|
| `GAME_ALREADY_STARTED` | ゲーム開始後に役職を変更できません | ゲーム開始後の役職設定変更 |
| `INVALID_ROLE_LIST` | 無効な役職リストです | 役職リストの構造や内容の問題 |
| `UNKNOWN_ROLE` | 未知の役職が指定されました: {roleName} | 未登録の役職名 |
| `PLAYER_ROLE_COUNT_MISMATCH` | プレイヤー数と役職数が一致しません | 人数と役職数の不一致 |
| `ROLE_DEPENDENCY_NOT_MET` | 役職「{roleName}」には役職「{dependency}」が必要です | 役職依存関係の不足 |
| `INVALID_ROLE_BALANCE` | 役職構成が不正です: {reason} | 役職バランスの問題 |
| `PLAYER_NOT_FOUND` | プレイヤーが見つかりません: {playerId} | 存在しないプレイヤーID |
| `PLAYER_ALREADY_ASSIGNED` | プレイヤーには既に役職が割り当てられています | 二重割り当て |
| `ROLE_ASSIGNMENT_INCOMPLETE` | 全プレイヤーの役職割り当てが完了していません | 未割り当てプレイヤー存在 |
| `INSUFFICIENT_PLAYERS` | プレイヤー数が不足しています | 最小プレイヤー数未満 |
| `UNAUTHORIZED_ROLE_INFO_ACCESS` | 役職情報へのアクセス権限がありません | 情報アクセス権限なし |

## 8. パフォーマンス考慮事項

特に大規模ゲームでのパフォーマンスを確保するための戦略：

1. **役職グループのキャッシング**:
   - 同じ役職を持つプレイヤーリストなど、頻繁に使用される情報をキャッシング
   - 役職割り当て時とプレイヤー状態変更時にのみキャッシュを更新

2. **マップ構造の活用**:
   - プレイヤーID→役職のマッピングを高速アクセス用に維持
   - 役職名→プレイヤーリストのマッピングによる検索最適化

3. **イベントの最適化**:
   - 高頻度イベントの購読者が多い場合のパフォーマンスを考慮
   - イベントバッチ処理の検討

4. **メモリ最適化**:
   - 役職情報の共有参照を活用し、メモリ使用量を削減
   - 不要になった参照の解放

## 9. 将来の拡張ポイント

将来的な機能拡張のためのポイント：

1. **カスタム役職システムの強化**:
   - 動的な役職登録と検証の拡張
   - 独自の能力定義フレームワーク

2. **役職進化/変更システム**:
   - ゲーム中の役職変更をサポートする拡張（狼化など）
   - 役職の進化や能力獲得メカニズム

3. **高度な情報可視性制御**:
   - よりきめ細かな情報公開ルール
   - 時間や条件に基づく可視性変更

4. **AIサポート**:
   - AIプレイヤーの役職判断支援
   - 役職配布のバランス最適化アルゴリズム

5. **分析機能**:
   - 役職パフォーマンス統計
   - 役職配布の傾向分析
