# GameManagerError.js テスト設計書（改善版・日本語限定）

## 1. テスト対象の概要

GameManagerError.jsモジュールは、GameManagerのエラー処理機能を提供するMix-inです。このモジュールは、ゲーム進行中のエラー検出、分類、処理、報告を担当し、一貫したエラーハンドリングと適切な回復メカニズムを提供します。

テスト対象となる主なメソッド:
- `setErrorPolicy(policy)` - エラー処理ポリシーの設定
- `validateOperation(operation, context)` - 操作の妥当性検証
- `handleGameError(error, context)` - エラーハンドリング
- `verifyStateAfterError()` - エラー後の状態整合性検証
- `getDiagnostics()` - デバッグ用エラー情報取得
- `logErrorDetails(error)` - エラー詳細のログ出力
- `safeExecute(operation, operationName, context)` - 安全な操作実行

## 2. テスト構成の概要

### 2.1 ファイル構成

- ファイル名: `GameManagerError.test.js`
- 配置場所: `/src/service/GameManager/__tests__/`
- 補助ファイル: `GameManagerErrorTestHelpers.js` - 複雑なモックと共通セットアップを分離し再利用性向上

### 2.2 テスト実行環境の明確化

- Node.js環境でのJestテストフレームワーク
- タイムアウト設定: 複雑なテストケース用に10秒に拡張（デフォルト5秒）
- メモリ使用制限: 大規模ゲーム状態のテスト用に適宜調整
- テスト分離: 各テストはステートレスで完全に独立して実行

### 2.3 テスト管理アプローチ

- **単体・統合テストの明確な区分**：
  - 単体テスト: GameManagerErrorの個々のメソッドを単独でテスト
  - 統合テスト: GameManagerの他のモジュールとの相互作用をテスト
  - E2Eテスト: エラー発生から回復までの一連のフローをテスト

- **テストデータ管理**:
  - 共通テストフィクスチャの定義と再利用
  - テストごとのデータ分離による独立性確保
  - 動的に生成されるテストケースの仕組み

## 3. 詳細テスト内容

### 3.1 初期化とポリシー設定テスト

#### テストグループ: `GameManagerError initialization`

**テストケース一覧**:
1. Mix-inが正しく適用されること
2. デフォルトのエラーポリシーが設定されていること
3. カスタムエラーポリシーが正しく設定されること
4. 無効なポリシー設定時に適切なフォールバックが行われること
5. **追加**: ポリシー設定後のErrorHandlerへの反映を検証
6. **追加**: 複数回のポリシー変更における一貫性検証

**検証項目**:
- Mix-in適用後のプロトタイプにすべての期待されるメソッドが存在すること
- 各ポリシー設定値が正しくErrorHandlerに委譲されること
- 無効な値に対するロバスト性

### 3.2 操作検証テスト

#### テストグループ: `Operation validation`

**テストケース一覧**:
1. 有効な操作が正しく検証されること
2. ゲーム開始状態の検証が正しく行われること
   - ゲーム未開始時の操作（役職設定、プレイヤー追加など）
   - ゲーム開始後のみの操作（投票、アクション実行など）
   - ゲーム終了後の操作制限
3. プレイヤー検証が正しく行われること
   - 存在しないプレイヤーID
   - 死亡プレイヤーの行動制限
4. フェーズ検証が正しく行われること
   - フェーズ依存操作（昼/夜、投票フェーズなど）
5. 各種オペレーション固有の検証ロジック
6. **追加**: 複合条件を持つ操作の検証（複数の制約条件が同時に適用される場合）
7. **追加**: 境界値での操作検証（ターン開始直後/直前など）
8. **追加**: 非同期操作検証のエッジケース

**検証項目**:
- 各操作タイプに対する適切な検証が行われること
- エラーコードとメッセージが適切であること
- 複数の制約条件が正しく適用されること
- 状態変化のタイミングでの検証の一貫性

### 3.3 エラーハンドリングテスト

#### テストグループ: `Error handling`

**テストケース一覧**:
1. 基本的なエラーハンドリングが正しく行われること
2. ErrorHandlerへのエラー委譲が適切に行われること
3. トランザクション中のエラーでロールバックが実行されること
4. エラー後の状態検証が正しく行われること
5. エラーイベントが適切に発火されること
6. **追加**: 非同期エラーハンドリングのテスト強化
7. **追加**: エラー連鎖（cascading errors）の処理検証
8. **追加**: コンテキスト情報のエラーへの付加と伝播
9. **追加**: エラー優先度に基づく処理順序の検証

**検証項目**:
- エラーオブジェクトの構造が期待通りであること
- エラーレベルに応じた適切な処理が行われること
- トランザクション状態の適切な管理（開始/ロールバック/コミット）
- 非同期コンテキストでのエラーキャプチャと処理

### 3.4 状態検証とリカバリーテスト

#### テストグループ: `State verification and recovery`

**テストケース一覧**:
1. エラー後の状態整合性検証が正しく行われること
2. ゲーム開始/終了状態に基づく検証が正しく行われること
3. プレイヤー状態の整合性確認が正しく行われること
4. 陣営バランスの確認が正しく行われること
5. 状態異常時の強制ゲーム終了が適切に行われること
6. **追加**: 複数モジュールにまたがる状態異常の検出
7. **追加**: 自動修復可能な状態不整合の回復メカニズム
8. **追加**: 修復不可能な状態の適切な終了処理
9. **追加**: 状態スナップショットとリストア機能のテスト
10. **追加**: 大規模ゲーム状態での検証パフォーマンステスト

**検証項目**:
- 状態整合性チェックの各種条件が正しく評価されること
- 回復処理が適切な順序で実行されること
- 自動修復と手動修復の境界が適切に設定されていること
- 状態変更履歴の適切な管理と使用

### 3.5 診断情報と出力テスト

#### テストグループ: `Diagnostics and logging`

**テストケース一覧**:
1. 診断情報の取得が正しく行われること
2. エラー詳細のログ出力が正しく行われること
3. デバッグモードでのみ特定の情報が出力されること
4. **追加**: 大規模診断情報の効率的な収集と管理
5. **追加**: センシティブ情報のフィルタリングと保護
6. **追加**: 構造化ログ出力のフォーマット検証
7. **追加**: 診断情報のユーザーレベル別適応（開発者/GM/プレイヤー）

**検証項目**:
- 診断情報に必要な全ての要素が含まれていること
- ログレベルに応じた適切な情報量の制御
- パフォーマンスに影響を与えない診断情報収集
- 異なるユーザーロールに適した診断情報の提供

### 3.6 安全な操作実行テスト

#### テストグループ: `Safe execution`

**テストケース一覧**:
1. 通常操作の実行が正しく行われること
2. エラー発生時の処理が適切に行われること
3. ネストした操作の実行が正しく行われること
4. 非同期操作の実行が正しく行われること
5. **追加**: Promise チェーンを含む非同期操作の強化テスト
6. **追加**: 非同期操作のタイムアウト処理
7. **追加**: 部分的に成功した操作のロールバックと補償トランザクション
8. **追加**: 並行実行される操作間の干渉テスト
9. **追加**: 長時間実行操作の中断と再開機能

**検証項目**:
- 同期・非同期操作の両方で一貫した結果が得られること
- エラー発生時の適切なコンテキスト保持
- 非同期操作の完了状態の正確な追跡
- 操作のアトミック性と分離性の保証

### 3.7 イベント発火テスト

#### テストグループ: `Event emission`

**テストケース一覧**:
1. 一般エラー発生時のイベント発火
2. 致命的エラー発生時のイベント発火
3. 警告レベルのエラー発生時のイベント発火
4. エラー回復処理時のイベント発火
5. **追加**: イベント発火順序の検証
6. **追加**: イベントペイロードの完全性検証
7. **追加**: イベントハンドラーのエラー処理
8. **追加**: ネストしたイベント発火の処理
9. **追加**: イベントループの検出と防止

**検証項目**:
- 正確なイベント名とデータペイロードの発火
- ポリシー設定に基づくイベント制御の正確さ
- イベント順序の一貫性
- イベントハンドラーでの例外の適切な管理

### 3.8 ロギングシステムテスト

#### テストグループ: `Logging system`

**テストケース一覧**:
1. カスタムロガーの設定と使用
2. ログレベルに応じた出力制御
3. **追加**: コンテキスト情報の適切なログ付与
4. **追加**: カスタムロガーとの統合テスト強化
5. **追加**: ログフォーマットの一貫性検証
6. **追加**: エラースタックの適切な表示

**検証項目**:
- メッセージ形式の一貫性
- ログレベルに基づく適切なフィルタリング
- エラーコンテキストの完全な記録
- パフォーマンスに配慮したロギング処理

### 3.9 統合テスト（追加セクション）

#### テストグループ: `Integration with other modules`

**テストケース一覧**:
1. PlayerManagerとの連携における状態整合性
2. PhaseManagerとの連携におけるフェーズ遷移エラー処理
3. RoleManagerとの連携における役職関連エラー処理
4. VoteManagerとの連携における投票エラー処理
5. ActionManagerとの連携におけるアクションエラー処理
6. 複数モジュールにまたがるトランザクション処理の整合性
7. エラー回復後の全モジュールの状態一貫性検証
8. 状態保存/復元処理における全モジュールの整合性

**検証項目**:
- モジュール間の連携によるエラー処理の一貫性
- 複合操作時の適切なトランザクション境界設定
- エラー情報の正確な伝播と解釈
- 回復後の全体状態の整合性

## 4. テスト実装のための準備

### 4.1 モックとセットアップ

#### モック要素

1. **GameManagerベースモック**
   - 最小限の機能を持つGameManager基底オブジェクト
   - 状態変数とメソッドスタブのみを実装
   - イベントシステムとエラーハンドラーへの参照

2. **EventSystemモック**
   - イベント発火と購読を記録するモック
   - イベント履歴の取得機能
   - イベントリスナー実行の制御機能

3. **ErrorHandlerモック**
   - エラー処理の詳細を記録するモック
   - エラーポリシー変更の効果を追跡
   - エラー履歴の収集と分析機能

4. **リアルなゲーム状態モック**
   - 実際のゲーム状態を模倣する包括的な状態オブジェクト
   - 様々なフェーズとターンの状態を再現
   - プレイヤー、役職、投票などの情報を含む

5. **オブザーバーモック**
   - 状態変更とイベント発火を監視するヘルパー
   - 期待される変更シーケンスの検証
   - タイミング依存テストのためのユーティリティ

#### セットアップと初期化

1. **テスト分離の強化**
   - 各テスト前に完全に独立した環境を再構築
   - モックオブジェクトの完全なリセット
   - グローバル状態の分離と隔離

2. **テスト固有のコンテキスト構築**
   - テストケースに応じた初期状態の構築
   - 複雑なゲーム状態の事前構築とシナリオ定義
   - 再利用可能なゲーム状態ファクトリ

### 4.2 ヘルパー関数と共通ユーティリティ

1. **状態生成ヘルパー**
   - 標準的なゲーム状態の簡易生成
   - カスタム状態要素のオーバーライド機能
   - 特定のエラー状態の生成

2. **エラー検証ヘルパー**
   - エラーオブジェクトの構造と内容検証
   - エラーコンテキストの深層検証
   - エラーチェーンとスタック情報の分析

3. **非同期テストユーティリティ**
   - 非同期操作の完了待機と結果検証
   - タイミング制御と同期ポイント管理
   - 非同期エラーの捕捉と分析

4. **トランザクション検証ユーティリティ**
   - トランザクション状態の追跡
   - 状態変更履歴の記録と検証
   - ロールバック効果の完全性検証

5. **パフォーマンス測定ユーティリティ**
   - 操作実行時間の測定
   - メモリ使用状況の追跡
   - スケーラビリティテスト用のデータ生成

## 5. エッジケースとストレステスト

### 5.1 複雑なエラーシナリオ

1. **エラーネスティングシナリオ**
   - エラーハンドリング中に発生するエラー
   - 複数階層のネストされたエラーチェーン
   - 回復処理中の二次エラー

2. **同時エラーシナリオ**
   - 複数のエラーが同時に発生する状況
   - 優先度に基づくエラー処理順序
   - エラー集約と統合報告メカニズム

3. **循環依存エラーシナリオ**
   - 相互依存するモジュール間でのエラー伝播
   - 循環参照によるエラー処理の無限ループ
   - 循環検出と緊急停止メカニズム

### 5.2 状態整合性エッジケース

1. **非修復可能な状態シナリオ**
   - 致命的な状態破損のシミュレーション
   - 部分的に回復可能な状態の処理
   - 最小限の情報損失での緊急保存処理

2. **矛盾する勝利条件シナリオ**
   - 複数陣営が同時に勝利条件を満たす状況
   - 勝利条件の優先度競合の解決
   - 勝利判定の一貫性保証

3. **状態履歴不整合シナリオ**
   - 累積的な状態変更の整合性検証
   - 状態履歴と現在状態の矛盾解決
   - 部分的な履歴欠損からの復旧

### 5.3 パフォーマンスとスケーラビリティ

1. **大規模ゲーム状態シナリオ**
   - 多数のプレイヤー（50人以上）でのエラー処理
   - 長時間実行ゲーム（100ターン以上）での状態検証
   - 複雑な役職構成での相互作用エラー

2. **高頻度エラーシナリオ**
   - 短時間での大量エラー発生時の処理能力
   - エラーバッファリングと集約メカニズム
   - エラー処理のスロットリングとプライオリティキュー

3. **メモリ制約シナリオ**
   - 限られたメモリ環境でのエラー処理
   - 大量診断情報のストリーミング出力
   - メモリ効率的なエラー履歴管理

## 6. テストカバレッジと品質指標

### 6.1 カバレッジ目標

- **関数カバレッジ**: 100%
- **分岐カバレッジ**: 95%以上（改善）
- **ステートメントカバレッジ**: 95%以上（改善）
- **行カバレッジ**: 95%以上（改善）

### 6.2 品質指標の追加

1. **エラー回復率**
   - 自動回復可能なエラーの割合
   - 回復後の状態整合性成功率
   - エラー連鎖の封じ込め効果

2. **エラー識別精度**
   - エラーの根本原因特定の正確性
   - エラーメッセージの明確さと具体性
   - ユーザーによるエラー解決容易性

3. **パフォーマンスベンチマーク**
   - エラー処理の平均応答時間
   - 大規模状態での検証パフォーマンス
   - 連続エラー処理のスループット

## 7. テスト実行と継続的統合

### 7.1 テスト実行シーケンス

1. **基本機能テスト**
   - 基本的なエラー処理機能のテスト（最初に実行）
   - 基本的な状態検証機能のテスト
   - 基本的なポリシー管理機能のテスト

2. **拡張機能テスト**
   - 高度なエラー処理シナリオのテスト
   - 複雑な状態検証シナリオのテスト
   - カスタムロギングのテスト

3. **統合テスト**
   - 他モジュールとの連携テスト
   - 完全なエラー処理フローテスト
   - フルシステムテスト

4. **パフォーマンステスト**
   - スケーラビリティテスト
   - ストレステスト
   - 長時間安定性テスト

### 7.2 継続的統合設定

1. **テスト自動化パイプライン**
   - プルリクエスト時の基本・拡張テスト実行
   - 夜間ビルドでの完全テストスイート実行
   - 週次パフォーマンス回帰テスト

2. **テストレポート生成**
   - カバレッジレポートの生成と保管
   - テスト失敗時の詳細診断情報収集
   - 時系列パフォーマンス分析

3. **品質ゲート**
   - 最小カバレッジ基準の設定
   - 最大許容エラー率の設定
   - パフォーマンス回帰検出閾値

## 8. テスト環境と設定

### 8.1 テスト環境設定

1. **Node.js環境構成**
   - Node.js最新LTS版でのテスト実行
   - メモリ制限の明示的構成（例: --max-old-space-size=4096）
   - タイムアウト設定の延長（30秒）

2. **Jest設定オプション**
   - テストタイムアウト: 30秒（複雑なシナリオ用）
   - バッファサイズ: 10MB（大きな状態オブジェクト用）
   - 並列実行スレッド: 4（最適なパフォーマンス用）
   - スナップショットシリアライザーのカスタマイズ

3. **モック動作設定**
   - 自動モックリセット設定
   - コンソール出力のクリーンキャプチャ
   - 時間依存テストの決定的動作

### 8.2 テストフィクスチャと外部依存

1. **ゲーム状態フィクスチャ**
   - 標準ゲーム状態テンプレート
   - 特殊シナリオ用の事前定義状態
   - 大規模ゲーム状態ジェネレーター

2. **外部依存のモック**
   - ファイルシステムアクセスのモック
   - ランダム生成器の決定的代替
   - タイマーと時間関連機能のモック

## 9. 将来の拡張とメンテナンス

### 9.1 テスト拡張計画

1. **自動テストケース生成**
   - エッジケースを自動的に検出するファジングテスト
   - プロパティベーステスト導入
   - 実際のエラーデータからの回帰テスト生成

2. **パフォーマンスプロファイリング**
   - メモリ使用と割り当てのプロファイリング
   - ホットスポットと最適化候補の特定
   - 非同期操作のボトルネック分析

3. **セキュリティテスト強化**
   - エラー情報からの情報漏洩テスト
   - リソース枯渇攻撃耐性テスト
   - 入力検証の堅牢性テスト

### 9.2 テスト自動化の改善

1. **継続的テスト改善**
   - テストカバレッジの定期的な分析と改善
   - 複雑なテストケースの分解と単純化
   - テスト実行時間の最適化

2. **テスト資産管理**
   - テストフィクスチャの一元管理
   - テスト関連知識ベースの構築
   - テスト結果の履歴分析と傾向把握

## 10. テスト文書化と知識共有

1. **テスト設計文書**
   - 本設計書の継続的な更新
   - テスト実装ガイドの作成
   - 特殊テストケースの解説

2. **トラブルシューティングガイド**
   - 一般的なテスト失敗の原因と解決策
   - 環境依存問題のデバッグ手順
   - パフォーマンス問題の診断方法

3. **ベストプラクティス**
   - GameManagerErrorテスト拡張のガイドライン
   - 効果的なモック作成パターン
   - 効率的なテストケース設計手法
