# GameManagerError.js 改善設計書

## 概要

本書は `GameManagerError.js` モジュールの設計改善案を示すものです。Mix-in パターンを用いたエラー処理システムを基本的な設計としながら、テスト容易性、国際化対応、ロギング抽象化、拡張性の向上などの改善を図ります。

## 1. 基本構造

### ファイル情報
```
ファイルパス: src/service/GameManager/GameManagerError.js
```

### モジュールの目的

このモジュールはGameManagerのエラー処理機能を提供し、以下の役割を担います：

- エラーの検出と分類
- エラーメッセージの生成
- エラー処理ポリシーの管理
- エラー発生時の状態回復
- デバッグ情報の提供

### Mix-in パターンの継続採用

GameManagerErrorMixin関数とapplyMixin関数による構造は維持します。GameManagerのプロトタイプにエラー処理メソッドを追加する設計です。

## 2. 改善点

### 2.1 ロギング機構の抽象化

#### ロギングインターフェース定義

エラーログを出力する際、コンソールへの直接出力ではなく抽象化されたロギングインターフェースを使用します。

**ロガーインターフェース**:
- debug(message, context)
- info(message, context)
- warning/warn(message, context)
- error(message, context)
- fatal(message, context)

**ロガー設定メソッド**:
- setLogger(logger) - ロガーインスタンスを設定
- getLogger() - 現在のロガーを取得

**デフォルトロガー**:
コンソールへの出力を行うシンプルなデフォルトロガーを提供し、外部ロガーが設定されていない場合に使用します。

#### 使用例イメージ

ロガーを使用したエラー記録の例：
- `this.getLogger().error('エラーが発生しました', { code: error.code, context });`

### 2.2 エラーコードの拡張性強化

#### カスタムエラーコード登録機能

役職プラグインやルールアドオンが独自のエラーコードを追加できるよう、登録機能を提供します。

**エラーコード管理機能**:
- registerErrorCode(code, config) - カスタムエラーコードを登録
- extendErrorCatalog(catalog) - 複数のエラーコードをまとめて登録
- getErrorCodeInfo(code) - エラーコードの情報を取得

**カスタムエラー名前空間**:
プラグイン間のエラーコードの衝突を避けるため、名前空間を導入します。例えば「PLUGIN_NEKOMATA_INVALID_TARGET」など。

### 2.4 テスト容易性の向上

#### エラー状態シミュレーション機能

テスト時にさまざまなエラー状況を再現するための機能を提供します。

**テスト支援機能**:
- simulateError(code, context) - 特定のエラーを発生させる
- getLastError() - 最後に発生したエラーを取得
- clearErrorHistory() - エラー履歴をクリア

#### モック化対応

テスト時にErrorHandlerをモック化しやすくするための設計を導入します。

**モック支援機能**:
- インターフェースの明確な定義
- 依存関係の注入ポイントの明示
- テスト用フックの提供

### 2.5 エラーヒストリー管理の強化

#### 詳細なエラー履歴管理

エラーの発生履歴を保持し、分析できる機能を強化します。

**エラー履歴機能**:
- getErrorHistory(filter, limit) - エラー履歴を取得
- getErrorStatistics() - エラー統計を取得
- exportErrorReport() - エラーレポートを生成

**エラー分析機能**:
- 同種エラーの頻度分析
- エラー発生パターンの検出
- 関連するゲーム状態の記録

### 2.6 パフォーマンス最適化

#### 最適化戦略

エラー処理によるパフォーマンス低下を防ぐための最適化を行います。

**最適化ポイント**:
- 検証処理の軽量化
- 診断情報収集の遅延評価
- エラー頻度に基づく処理調整

**条件付き処理**:
- DEBUG モードでのみ詳細情報を収集
- エラー頻度に応じた警告抑制メカニズム
- エラーオブジェクトの軽量化

## 3. 修正後メソッド定義

### 主要メソッド

1. **setErrorPolicy(policy)**
   - エラー処理ポリシーを設定します
   - 引数: policy (ポリシー設定オブジェクト)
   - 戻り値: 設定されたポリシー

2. **validateOperation(operation, context)**
   - 操作の妥当性を検証します
   - 引数: operation (操作名), context (コンテキスト情報)
   - 戻り値: 妥当性の結果と、不正な場合はエラー情報

3. **handleGameError(error, context)**
   - エラーをハンドリングします
   - 引数: error (エラーオブジェクト), context (コンテキスト情報)
   - 戻り値: 処理されたエラー

4. **verifyStateAfterError()**
   - エラー発生後の状態整合性を検証します
   - 戻り値: なし

5. **getDiagnostics()**
   - デバッグ用にゲームの診断情報を取得します
   - 戻り値: 診断情報オブジェクト

6. **logErrorDetails(error)**
   - エラー詳細をログ出力します
   - 引数: error (エラーオブジェクト)
   - 戻り値: なし

7. **safeExecute(operation, operationName, context)**
   - 操作を安全に実行します（エラーハンドリング付き）
   - 引数: operation (実行関数), operationName (操作名), context (コンテキスト情報)
   - 戻り値: 操作の結果、エラー時はnull

### 追加メソッド

1. **setLogger(logger)**
   - ロガーを設定します
   - 引数: logger (ロガーインスタンス)
   - 戻り値: this (メソッドチェーン用)

2. **getLogger()**
   - 現在のロガーを取得します
   - 戻り値: ロガーインスタンス

3. **getErrorMessage(code, params)**
   - エラーコードに対応するメッセージを取得します
   - 引数: code (エラーコード), params (置換パラメータ)
   - 戻り値: メッセージ文字列

4. **registerErrorCode(code, config)**
   - カスタムエラーコードを登録します
   - 引数: code (エラーコード), config (エラー設定)
   - 戻り値: 登録成功時にtrue

6. **getErrorHistory(filter, limit)**
   - エラー履歴を取得します
   - 引数: filter (フィルター条件), limit (最大件数)
   - 戻り値: エラー履歴の配列

7. **simulateError(code, context)**
   - 特定のエラーをシミュレートします（テスト用）
   - 引数: code (エラーコード), context (コンテキスト情報)
   - 戻り値: シミュレートされたエラー

## 4. エラーコード体系

エラーコードは以下のカテゴリに分類し、階層構造を持たせます：

- **G**: ゲーム状態関連エラー (G001-G099)
  - G001: ゲーム未開始
  - G002: ゲーム既開始
  - G003: ゲーム既終了

- **P**: プレイヤー関連エラー (P001-P099)
  - P001: プレイヤー不在
  - P002: 無効なプレイヤー名
  - P003: 死亡プレイヤーアクション

- **F**: フェーズ関連エラー (F001-F099)
  - F001: 無効なフェーズ
  - F002: 無効なフェーズ遷移

- **A**: アクション関連エラー (A001-A099)
  - A001: 無効なアクション
  - A002: アクション不許可

- **V**: 投票関連エラー (V001-V099)
  - V001: 無効な投票者
  - V002: 無効な投票対象
  - V003: 自己投票禁止

- **I**: 内部エラー (I001-I099)
  - I001: 内部エラー

- **X**: 拡張エラー (X001-X999)
  - カスタムエラー用の領域
  - 例：X001-X099：カスタム役職エラー
  - 例：X100-X199：カスタムルールエラー

## 5. エラーメッセージ例

```
{
  "G001": "ゲームが開始されていません",
  "G002": "ゲームは既に開始されています",
  "G003": "ゲームは既に終了しています",
  "P001": "指定されたプレイヤーが見つかりません",
  "P002": "無効なプレイヤー名です",
  "P003": "死亡したプレイヤーは行動できません"
}
```

## 6. ロギングインターフェース

```
interface Logger {
  debug(message: string, context?: object): void;
  info(message: string, context?: object): void;
  warn(message: string, context?: object): void;
  error(message: string, context?: object): void;
  fatal(message: string, context?: object): void;
}
```

## 7. 実装上の考慮事項

1. **段階的実装**:
   - まず基本的なエラーハンドリング機能を実装
   - 次に国際化とロギング抽象化を追加
   - 最後にテスト支援機能とエラー履歴管理を実装

2. **下位互換性**:
   - 既存のエラーコードとの互換性維持
   - 既存のエラーハンドリングフローを維持

3. **拡張性**:
   - プラグインシステムとの統合
   - 将来的なエラー処理機構の拡張に対応

4. **テスト戦略**:
   - モック/スタブによるテスト
   - エラーシナリオのテストケース網羅
   - ストレステスト（多数のエラー発生時の挙動）

## 8. イベントフロー

エラー発生時の主要なイベントフロー：

1. エラー検出
2. エラー前処理（`error.before`イベント）
3. エラーハンドリング
4. トランザクションのロールバック（必要な場合）
5. 状態整合性検証
6. エラー後処理（`error.after`イベント）
7. エラー通知（`error.notification`イベント）

## 9. 改善のメリット

1. **メンテナンス性の向上**:
   - 明確なエラーコード体系による問題の特定しやすさ
   - ロギング抽象化による出力柔軟性
   - エラー管理の一元化

2. **テスト品質向上**:
   - エラーシミュレーション機能によるテスト容易性
   - エラー統計による品質測定
   - 効率的なバグ検出

3. **拡張性の強化**:
   - カスタムエラーコード登録によるプラグイン対応
   - エラー処理ポリシーのカスタマイズ性
   - 新機能追加時のエラー統合が容易

4. **パフォーマンス改善**:
   - 軽量化されたエラー処理
   - 条件付き詳細情報収集
   - エラー状況に応じた処理最適化

5. **デバッグ効率の向上**:
   - 詳細なエラー情報の体系的な収集
   - エラー発生状況の再現性向上
   - 開発ログの質の向上

これらの改善により、人狼ゲームGM支援ライブラリのエラー処理はより堅牢で、拡張性が高く、保守しやすい形に進化します。
