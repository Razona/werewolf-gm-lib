# GameManagerState モジュール設計書（改良版）

## 1. 概要

`GameManagerState.js` はGameManagerの状態管理機能を提供するモジュールです。ゲーム全体の状態の管理、状態変更の追跡、状態の永続化と復元などを担当します。本モジュールは疎結合なイベント駆動型アーキテクチャに基づき、状態変更を一貫して管理し、ゲームの信頼性と予測可能性を確保します。

## 2. 役割と責務

- **状態の保持**: ゲームの現在の状態を信頼できる唯一の情報源として管理
- **状態の整合性確保**: 状態変更の検証と整合性の維持
- **状態の変更管理**: トランザクション機構による原子的な状態変更
- **状態のライフサイクル管理**: 状態の初期化、更新、終了処理
- **状態の永続化**: ゲーム状態の保存と復元機能
- **状態情報の提供**: 現在の状態や要約情報の取得API
- **状態変更の通知**: 状態変更時のイベント発火
- **状態の監査**: 変更履歴の記録と追跡

## 3. 依存モジュール

このファイルはGameManagerのMix-inとして実装され、以下のモジュールと連携します：

- **EventSystem**: イベント発火と購読のための基盤
- **ErrorHandler**: エラー処理と検証の標準化
- **各種マネージャー**: 各ドメイン固有の状態情報の取得

## 4. 状態データ構造

### 4.1 基本状態構造

```javascript
// 内部状態の基本構造
this.state = {
  // メタデータ
  id: "game-123",              // ゲームの一意識別子
  version: "1.0.0",            // 状態データバージョン
  
  // 進行状態
  isStarted: false,            // ゲーム開始状態
  isEnded: false,              // ゲーム終了状態
  turn: 0,                     // 現在のターン
  phase: null,                 // 現在のフェーズ
  
  // プレイヤー情報 (PlayerManagerと連携)
  players: [],                 // プレイヤー情報の参照
  
  // 役職情報 (RoleManagerと連携)
  roles: {
    list: [],                  // 役職リスト
    distributed: false,        // 配布済みかどうか
    distribution: {}           // 配布結果
  },
  
  // 投票情報 (VoteManagerと連携)
  votes: {
    current: [],               // 現在の投票
    history: []                // 投票履歴
  },
  
  // アクション情報 (ActionManagerと連携)
  actions: {
    pending: [],               // 保留中のアクション
    history: []                // アクション履歴
  },
  
  // 勝利情報
  winner: null,                // 勝者（陣営）
  winningPlayers: [],          // 勝利プレイヤーIDリスト
  winReason: null,             // 勝利理由
  
  // 設定情報
  regulations: {},             // レギュレーション設定
  options: {},                 // その他のゲームオプション
  
  // 時間情報
  startTime: null,             // 開始時刻
  endTime: null,               // 終了時刻
  lastUpdate: null,            // 最終更新時刻
  
  // 履歴データ
  history: [],                 // ターン履歴
  events: [],                  // 重要イベント履歴
  lastDeath: null              // 最後の死亡情報
};
```

### 4.2 トランザクション管理構造

```javascript
// トランザクション管理用
this.transaction = {
  active: false,               // トランザクション中かどうか
  snapshot: null,              // 状態スナップショット
  changes: [],                 // 変更ログ
  timestamp: null,             // 開始時刻
  metadata: {}                 // トランザクション追加情報
};
```

### 4.3 保存データ構造

```javascript
// 保存データ構造
{
  id: "save-123",              // 保存ID
  gameId: "game-123",          // ゲームID
  version: "1.0.0",            // 保存データバージョン
  timestamp: 1621234567890,    // 保存時刻
  state: { /* 完全な状態オブジェクト */ },
  metadata: {                  // メタデータ
    createdBy: "system",       // 作成者
    description: "",           // 説明
    tags: []                   // タグ
  },
  checksum: "abc123def456"     // データ整合性チェック用
}
```

## 5. Mix-in関数の定義

GameManagerのプロトタイプに以下のメソッドを追加します：

### 5.1 状態取得関連

#### getCurrentState(options)
**説明**: 現在のゲーム状態を取得します。  
**アクセス**: public  
**パラメータ**:
- options: 取得オプション
  - includeHistory: 履歴を含めるか（デフォルト: false）
  - includeDetails: 詳細情報を含めるか（デフォルト: true）
  - filterFunction: カスタムフィルター関数  
**戻り値**: 現在のゲーム状態  
**処理内容**:
- 現在の基本ゲーム状態を構築
- オプションに基づく情報の取捨選択
- プレイヤー情報の収集（各マネージャーから）
- タイムスタンプの追加
- オプション指定の場合に情報可視性フィルターを適用
- 状態オブジェクトの返却

#### getGameSummary()
**説明**: ゲーム状態の要約を取得します。  
**アクセス**: public  
**戻り値**: ゲーム状態の要約  
**処理内容**:
- 生存プレイヤーの取得
- プレイヤー統計の計算（役職分布など）
- 陣営統計の計算
- ターン・フェーズ情報の要約
- 要約データの返却

#### isGameStarted()
**説明**: ゲームが開始されているか確認します。  
**アクセス**: public  
**戻り値**: ゲームが開始されていればtrue  
**処理内容**:
- ゲーム状態から開始状態を返却
- 状態が未初期化の場合はfalseを返却

#### isGameEnded()
**説明**: ゲームが終了しているか確認します。  
**アクセス**: public  
**戻り値**: ゲームが終了していればtrue  
**処理内容**:
- ゲーム状態から終了状態を返却
- 状態が未初期化の場合はfalseを返却

#### getStateHistory(options)
**説明**: ゲーム状態の履歴を取得します。  
**アクセス**: public  
**パラメータ**:
- options: 履歴取得オプション
  - turn: 特定ターンの履歴のみ取得
  - limit: 取得する最大件数
  - reverse: 新しい順に取得（デフォルト: true）  
**戻り値**: 状態履歴の配列  
**処理内容**:
- 履歴データの取得
- フィルタリングと並べ替え
- 整形された履歴データの返却

### 5.2 状態更新関連

#### updateState(partialState, options)
**説明**: ゲーム状態を部分的に更新します。  
**アクセス**: public  
**パラメータ**:
- partialState: 更新する部分的な状態
- options: 更新オプション
  - silent: イベント発火を抑制するか（デフォルト: false）
  - validate: 更新前に検証するか（デフォルト: true）
  - mergeArrays: 配列をマージするか上書きするか（デフォルト: false）  
**戻り値**: 更新された状態  
**処理内容**:
- オプションを使用した場合の検証
- 状態更新前イベント発火（silent=falseの場合）
- 部分的な状態更新（深いマージ）
- タイムスタンプの更新
- トランザクション中の場合は変更を記録
- 状態更新後イベント発火（silent=falseの場合）
- 更新された状態の返却

#### resetState()
**説明**: ゲーム状態を初期状態にリセットします。  
**アクセス**: public  
**戻り値**: 初期化された状態  
**処理内容**:
- リセット前イベント発火
- 状態の初期化
- タイムスタンプの更新
- リセット後イベント発火
- 初期化された状態の返却

#### mergeStateUpdate(currentState, updates, options)
**説明**: 状態の更新をマージする内部メソッドです。  
**アクセス**: private  
**パラメータ**:
- currentState: 現在の状態
- updates: 更新内容
- options: マージオプション  
**戻り値**: マージされた状態  
**処理内容**:
- 特殊フィールドの処理（配列のマージ/置換など）
- 深いマージの実行
- タイムスタンプの更新
- マージされた状態の返却

#### validateStateUpdate(updates)
**説明**: 状態更新の検証を行います。  
**アクセス**: private  
**パラメータ**:
- updates: 検証する更新内容  
**戻り値**: 検証結果（有効な場合はtrue）  
**処理内容**:
- 必須フィールドの検証
- 値の型と範囲の検証
- 状態の整合性チェック
- 無効な場合はエラー情報を含む結果を返却

### 5.3 状態保存・復元関連

#### saveGameState(saveId, options)
**説明**: ゲーム状態を保存します。  
**アクセス**: public  
**パラメータ**:
- saveId: 保存識別子（省略時は自動生成）
- options: 保存オプション
  - metadata: 追加のメタデータ
  - includeHistory: 履歴を含めるか
  - compress: データを圧縮するか  
**戻り値**: 保存されたゲーム状態  
**処理内容**:
- 保存IDの生成または使用
- 完全なゲーム状態の構築
- チェックサムの計算
- メタデータの設定
- 保存前イベント発火
- オプションに基づくデータ処理（圧縮など）
- 保存データの構築
- 保存後イベント発火
- 保存データの返却

#### buildFullGameState(options)
**説明**: 完全なゲーム状態を構築する内部メソッドです。  
**アクセス**: private  
**パラメータ**:
- options: 構築オプション  
**戻り値**: 完全なゲーム状態  
**処理内容**:
- 基本状態の取得
- 各マネージャーから詳細情報の収集
  - プレイヤー状態の完全な情報
  - 役職情報
  - 投票履歴
  - アクション履歴
- オプションに基づく情報の取捨選択
- 完全な状態オブジェクトの返却

#### loadGameState(saveData, options)
**説明**: 保存されたゲーム状態から復元します。  
**アクセス**: public  
**パラメータ**:
- saveData: 保存されたゲーム状態
- options: 読み込みオプション
  - validateOnly: 検証のみ行い、実際に復元しない
  - resetBeforeLoad: 読み込み前に状態をリセットするか  
**戻り値**: 復元成功時にtrue  
**処理内容**:
- 復元前のバリデーション
- チェックサムの検証
- バージョン互換性の確認
- 読み込み前イベント発火
- オプション指定時は状態リセット
- データの変換処理（必要な場合）
- 状態の復元
  - 基本状態の設定
  - 各マネージャーへの状態復元依頼
  - フェーズとターンの設定
  - タイムスタンプの更新
- 整合性の再検証
- 読み込み後イベント発火
- 結果の返却

#### validateSaveData(saveData)
**説明**: 保存データの検証を行います。  
**アクセス**: private  
**パラメータ**:
- saveData: 検証する保存データ  
**戻り値**: 検証結果（有効な場合はtrue）  
**処理内容**:
- 必須フィールドの確認（id, version, state, timestamp）
- バージョン互換性の確認
- チェックサムの検証
- 状態データの妥当性確認
- 無効な場合はエラー情報を含む結果を返却

#### migrateSaveData(saveData)
**説明**: 古いバージョンの保存データを現在のバージョンに変換します。  
**アクセス**: private  
**パラメータ**:
- saveData: 変換する保存データ  
**戻り値**: 変換された保存データ  
**処理内容**:
- バージョンの確認
- バージョンごとの変換処理の適用
- 変換ログの記録
- 変換されたデータの返却

### 5.4 トランザクション関連

#### beginTransaction(metadata)
**説明**: トランザクションを開始します（変更の一括適用のため）。  
**アクセス**: public  
**パラメータ**:
- metadata: トランザクションのメタデータ（オプション）  
**戻り値**: トランザクション開始成功時にtrue  
**処理内容**:
- トランザクション状態の確認（既に実行中の場合はエラー）
- スナップショットの作成
- トランザクション状態の初期化
- タイムスタンプの記録
- メタデータの設定
- トランザクション開始イベント発火
- 結果の返却

#### createStateSnapshot()
**説明**: 現在の状態のスナップショットを作成します。  
**アクセス**: private  
**戻り値**: 状態スナップショット  
**処理内容**:
- 現在の状態の深いコピーを作成
  - 効率化のため、履歴など一部大きなデータは参照のみ保持
- スナップショットメタデータの設定
- スナップショットの返却

#### restoreStateSnapshot(snapshot)
**説明**: 状態スナップショットから状態を復元します。  
**アクセス**: private  
**パラメータ**:
- snapshot: 復元するスナップショット  
**戻り値**: 復元成功時にtrue  
**処理内容**:
- スナップショットの検証
- 現在の状態を完全にスナップショットで置き換え
- 復元イベントの発火
- 結果の返却

#### recordTransactionChange(type, data)
**説明**: トランザクション中の変更を記録します。  
**アクセス**: private  
**パラメータ**:
- type: 変更タイプ（'update', 'add', 'remove'など）
- data: 変更データ  
**処理内容**:
- トランザクション状態の確認
- タイムスタンプの設定
- 変更情報の構築
- 変更ログへの追加

#### commitTransaction()
**説明**: トランザクションをコミットします（変更を確定）。  
**アクセス**: public  
**戻り値**: コミット成功時にtrue  
**処理内容**:
- トランザクション状態の確認（実行中でない場合はエラー）
- コミット前イベント発火
- トランザクション変更の適用確認
- 変更履歴の最終処理
- トランザクションコミットイベント発火
- トランザクション状態のクリア
- 結果の返却

#### rollbackTransaction()
**説明**: トランザクションをロールバックします（変更を取り消し）。  
**アクセス**: public  
**戻り値**: ロールバック成功時にtrue  
**処理内容**:
- トランザクション状態の確認（実行中でない場合はエラー）
- スナップショットの確認
- ロールバック前イベント発火
- スナップショットからの状態復元
- トランザクションロールバックイベント発火
- トランザクション状態のクリア
- 結果の返却

#### isInTransaction()
**説明**: 現在トランザクション中かどうかを確認します。  
**アクセス**: public  
**戻り値**: トランザクション中の場合にtrue  
**処理内容**:
- トランザクション状態フラグの返却

### 5.5 監査とデバッグ関連

#### getStateChanges(options)
**説明**: 状態変更の履歴を取得します。  
**アクセス**: public  
**パラメータ**:
- options: 取得オプション
  - limit: 取得する最大件数
  - since: 特定のタイムスタンプ以降の変更のみ取得  
**戻り値**: 変更履歴の配列  
**処理内容**:
- 変更履歴の取得
- フィルタリングと制限の適用
- 変更履歴の返却

#### createDebugSnapshot()
**説明**: デバッグ用の詳細な状態スナップショットを作成します。  
**アクセス**: public  
**戻り値**: デバッグ情報を含むスナップショット  
**処理内容**:
- 現在の状態の深いコピーを作成
- 各マネージャーからのデバッグ情報収集
- 履歴情報の要約
- イベントログの追加
- デバッグメタデータの追加
- スナップショットの返却

#### compareStates(stateA, stateB)
**説明**: 2つの状態を比較し、差分を取得します。  
**アクセス**: public  
**パラメータ**:
- stateA: 比較元の状態
- stateB: 比較先の状態  
**戻り値**: 差分情報  
**処理内容**:
- 両状態の構造比較
- 差分の検出と分類
- 変更、追加、削除項目のリスト化
- 差分サマリーの生成
- 差分情報の返却

## 6. イベントリスト

状態管理に関連するイベント一覧：

| イベント名 | 発火タイミング | データ内容 |
|------------|----------------|------------|
| `state.update.before` | 状態更新前 | `{currentState, updates, source}` |
| `state.update.after` | 状態更新後 | `{previousState, currentState, updates, changes}` |
| `state.reset.before` | 状態リセット前 | `{currentState}` |
| `state.reset.after` | 状態リセット後 | `{previousState, currentState}` |
| `state.save.before` | 状態保存前 | `{saveId, options, timestamp}` |
| `state.save.after` | 状態保存後 | `{saveId, saveData, options, timestamp}` |
| `state.load.before` | 状態読み込み前 | `{saveData, options, timestamp}` |
| `state.load.after` | 状態読み込み後 | `{saveId, previousState, currentState, timestamp}` |
| `state.transaction.begin` | トランザクション開始時 | `{metadata, timestamp}` |
| `state.transaction.commit` | トランザクションコミット時 | `{changes, duration, metadata, timestamp}` |
| `state.transaction.rollback` | トランザクションロールバック時 | `{changes, reason, metadata, timestamp}` |
| `state.restore` | 状態復元時 | `{source, previousState, currentState}` |
| `state.migrate` | 状態マイグレーション時 | `{fromVersion, toVersion, changes}` |
| `state.error` | 状態操作エラー時 | `{operation, error, context}` |

## 7. エラー処理

GameManagerState モジュールでは以下のエラーケースを定義し、処理します：

| エラーコード | 説明 | レベル |
|------------|------|-------|
| `STATE_INVALID_UPDATE` | 無効な状態更新フォーマット | error |
| `STATE_VALIDATION_FAILED` | 状態検証失敗 | error |
| `STATE_TRANSACTION_ALREADY_ACTIVE` | 既にトランザクションが開始されている | error |
| `STATE_NO_ACTIVE_TRANSACTION` | アクティブなトランザクションがない | error |
| `STATE_SNAPSHOT_INVALID` | 無効なスナップショット | error |
| `STATE_SAVE_INVALID` | 無効な保存データ | error |
| `STATE_VERSION_INCOMPATIBLE` | バージョン互換性エラー | error |
| `STATE_CHECKSUM_FAILED` | チェックサム検証失敗 | error |
| `STATE_LOAD_FAILED` | 状態読み込み失敗 | error |
| `STATE_INTEGRITY_VIOLATION` | 状態整合性違反 | fatal |

各エラーは ErrorHandler を通じて適切に処理され、状態の整合性を維持するための対策が実施されます。

## 8. 実装の注意点

### 8.1 状態の一貫性確保

- **イミュータブル更新**: 状態変更は常に新しいオブジェクトとして作成
- **アトミック操作**: 複数の関連フィールドの更新は原子的に実行
- **トランザクション処理**: 複雑な状態変更はトランザクションで管理
- **整合性検証**: 状態更新前後で整合性のチェックを実施
- **ロールバック機構**: エラー発生時に安全に前の状態に戻す機能

### 8.2 パフォーマンス最適化

#### 8.2.1 深いコピーの効率化

大規模な状態オブジェクトのコピーは以下の戦略で最適化します：

- **構造共有イミュータビリティ**: 変更のないオブジェクト部分は参照を再利用
- **レイジーコピー**: 実際に変更が必要な部分のみコピー
- **差分更新**: 変更のある部分のみを更新する仕組み
- **履歴データの圧縮**: 古いターンの詳細データを要約情報に圧縮

#### 8.2.2 メモリ使用量の最適化

- **スナップショットの選択的作成**: トランザクション開始時に必要な情報のみスナップショット
- **大きなデータの参照管理**: 履歴データなどは参照で管理し不要時に解放
- **状態サイズの監視**: 状態サイズが一定以上になった場合に警告や最適化処理

### 8.3 拡張性と互換性

- **バージョン管理**: 状態データ構造の変更はバージョン管理
- **マイグレーション機構**: 古いバージョンのデータを新しい形式に変換
- **下位互換性**: 新しいフィールド追加時は初期値を設定し下位互換性を維持
- **拡張ポイント**: プラグインやカスタム状態のための拡張ポイントを提供

### 8.4 セキュリティ考慮

- **データ検証**: 外部から読み込む保存データの厳格な検証
- **チェックサム**: 保存データの整合性を検証するチェックサム機構
- **権限ベースのアクセス制御**: 状態情報へのアクセスを権限に基づき制御
- **不正な状態変更の防止**: イベントソーシングによる状態変更の追跡と検証

## 9. 利用シナリオ

### 9.1 基本的な状態管理

**シナリオ**:
- 現在のゲーム状態の取得
- ゲーム開始状態の確認
- ゲーム要約情報の取得（生存者数、陣営分布など）
- 状態の部分的な更新（フェーズとターンの更新）
- フィルタリングされた状態情報の取得（履歴や詳細を除外）

**利用方法**:
- `getCurrentState()`メソッドで現在の状態を取得
- `isGameStarted()`メソッドでゲーム開始状態を確認
- `getGameSummary()`メソッドで要約情報を取得
- `updateState()`メソッドで状態を部分的に更新
- オプション付きの`getCurrentState()`呼び出しで特定情報のみ取得

### 9.2 トランザクション処理

**シナリオ**:
- 複数の関連する状態変更を一括で安全に実行
- エラー発生時にすべての変更を取り消し
- トランザクション実行中に追加のカスタム変更を記録

**利用手順**:
1. `beginTransaction()`メソッドでトランザクションを開始
2. 複数の操作（プレイヤー死亡処理、フェーズ遷移など）を実行
3. 必要に応じて`recordTransactionChange()`メソッドで追加変更を記録
4. 問題なければ`commitTransaction()`メソッドで変更を確定
5. エラー発生時は`rollbackTransaction()`メソッドで変更を取り消し

### 9.3 状態の保存と復元

**シナリオ**:
- 現在のゲーム状態をカスタムメタデータと共に保存
- 保存データの検証のみを行い、実際の読み込みは行わない
- 別のゲームインスタンスでの状態復元

**利用方法**:
- メタデータやオプションを指定して`saveGameState()`メソッドを呼び出し
- 検証のみのオプションで`loadGameState()`メソッドを呼び出し
- 新しいGameManagerインスタンスで`loadGameState()`メソッドを使用して状態を復元

### 9.4 デバッグと状態分析

**シナリオ**:
- 詳細なデバッグ情報の取得
- 以前の状態と現在の状態の差分分析
- 変更内容のサマリーと変更されたフィールドの確認

**利用方法**:
- `createDebugSnapshot()`メソッドで詳細なデバッグスナップショットを作成
- `compareStates()`メソッドで2つの状態を比較し差分情報を取得

## 10. テスト戦略

GameManagerState のテストは以下の戦略に基づいて設計します：

### 10.1 単体テスト

#### 状態取得のテスト
- 初期状態の取得テスト
- オプション付き状態取得テスト
- 異なるゲーム段階での状態取得テスト
- 状態要約情報の正確性テスト

#### 状態更新のテスト
- 単一フィールド更新テスト
- 複合フィールド更新テスト
- ネストした構造の更新テスト
- 配列の更新（マージ/置換）テスト
- 無効な更新の検証テスト

#### トランザクション処理のテスト
- 正常なトランザクションフローテスト
- 入れ子トランザクションの禁止テスト
- エラー時のロールバックテスト
- トランザクション中の状態変更記録テスト
- 長時間トランザクションのパフォーマンステスト

#### 保存と復元のテスト
- 基本的な保存と復元のテスト
- オプション付き保存テスト
- 無効な保存データの検証テスト
- 部分的なデータ復元テスト
- バージョン互換性のテスト
- マイグレーション機能のテスト

### 10.2 統合テスト

- 他のマネージャーとの連携テスト
- イベント発火と処理の整合性テスト
- エラーハンドリングの統合テスト
- ゲームフロー全体での状態管理テスト

### 10.3 パフォーマンステスト

- 大規模状態の更新パフォーマンステスト
- トランザクション処理の時間計測
- メモリ使用量の監視テスト
- 長時間ゲーム進行でのメモリリーク検出

### 10.4 耐障害性テスト

- エラー発生時の状態整合性テスト
- 不完全なデータ読み込み時の対応テスト
- ネットワーク障害シミュレーションテスト
- データ破損シナリオテスト

## 11. 拡張性と将来の発展

GameManagerState モジュールは以下の拡張ポイントを提供し、将来の発展に備えます：

### 11.1 プラグイン拡張

- **カスタム状態フィールド**: プラグインによる独自状態フィールドの追加
- **状態変更リスナー**: 状態変更をフックして処理するプラグインAPI
- **カスタム検証ルール**: 状態検証に独自ルールを追加する機能

### 11.2 永続化拡張

- **外部ストレージ連携**: データベースやクラウドストレージとの連携
- **増分バックアップ**: 差分のみを保存する効率的なバックアップ
- **自動バックアップ**: 定期的・イベント駆動の自動保存機能

### 11.3 分析機能

- **状態分析API**: ゲーム状態の統計分析機能
- **リプレイ機能**: 保存された状態からのゲーム再生
- **可視化支援**: 状態データの可視化ヘルパー

### 11.4 将来のアーキテクチャ進化

- **イベントソーシング**: 完全なイベントソーシングへの移行可能性
- **分散状態管理**: マルチプレイヤー環境での分散状態管理
- **リアルタイム同期**: クライアント間のリアルタイム状態同期

## 12. 結論

GameManagerState モジュールは人狼ゲームGM支援ライブラリの中核として、ゲーム状態の管理と永続化を担当します。イベント駆動型のアーキテクチャに基づき、高い信頼性と拡張性を提供します。

トランザクション処理や状態の一貫性保証機能により、複雑なゲーム状態の変更でも信頼性の高い処理が可能です。また、効率的な状態の差分更新や最適化されたスナップショット機能により、パフォーマンスと安定性を両立させています。

本モジュールは将来の拡張にも対応できるよう設計されており、プラグインを通じたカスタマイズや高度な永続化機能、分析ツールなどへの発展が可能です。これにより、シンプルなユースケースから複雑な本格的なゲーム管理まで幅広いニーズに対応できます。