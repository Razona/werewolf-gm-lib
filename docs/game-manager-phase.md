# GameManager - GameManagerPhase.js 設計書

## 概要

`GameManagerPhase.js` はGameManagerのフェーズ管理機能を提供するモジュールです。ゲームのフェーズ遷移、現在のフェーズ状態管理、フェーズ関連のイベント処理など、ゲーム進行の流れを制御します。

## 役割

- ゲームフェーズの遷移管理
- 現在のフェーズ状態の追跡
- ターン進行の管理
- フェーズ関連のイベント処理
- フェーズ固有のロジックの実行

## 依存モジュール

このファイルはGameManagerのMix-inとして実装され、GameManagerインスタンスのコンテキストで実行されるため、特にPhaseManagerとのインタラクションが中心となります。

## Mix-in関数の定義

GameManagerのプロトタイプに以下のメソッドを追加します：

### start()
**説明**: ゲームを開始します。  
**アクセス**: public  
**戻り値**: 開始成功時にtrue  
**処理内容**:
- ゲーム開始状態検証（既に開始済みではないか）
- プレイヤー数や役職割り当て状況の確認
- 開始前イベントの発火
- ゲーム状態の更新（開始状態に）
- 初期フェーズへの移行
- 開始後イベントの発火
- エラー処理

### nextPhase()
**説明**: 次のフェーズへ移行します。  
**アクセス**: public  
**戻り値**: 移行後のフェーズ情報  
**処理内容**:
- ゲーム開始状態と終了状態の確認
- 次フェーズ移行前イベントの発火
- フェーズ移行処理
- ターン進行処理（必要に応じて）
- フェーズ移行後イベントの発火
- 新フェーズの開始イベント発火
- フェーズ固有の処理の実行
- エラー処理

### moveToPhase(phaseId)
**説明**: 特定のフェーズへ直接移行します。  
**アクセス**: public  
**パラメータ**:
- phaseId: 移行先のフェーズID  
**戻り値**: 移行後のフェーズ情報  
**処理内容**:
- ゲーム開始状態と終了状態の確認
- フェーズ移行前イベントの発火
- 指定フェーズへの移行
- フェーズ移行後イベントの発火
- 新フェーズの開始イベント発火
- フェーズ固有の処理の実行
- エラー処理

### getCurrentPhase()
**説明**: 現在のフェーズを取得します。  
**アクセス**: public  
**戻り値**: 現在のフェーズ情報  
**処理内容**:
- ゲーム開始状態の確認
- 現在のフェーズ情報返却
- エラー処理

### getCurrentTurn()
**説明**: 現在のターン数を取得します。  
**アクセス**: public  
**戻り値**: 現在のターン数  
**処理内容**:
- ゲーム開始状態の確認
- 現在のターン数返却
- エラー処理

### getDayNightCycle()
**説明**: 現在の日（昼）か夜かを取得します。  
**アクセス**: public  
**戻り値**: "day"または"night"  
**処理内容**:
- ゲーム開始状態の確認
- 現在のフェーズから昼夜判定
- エラー処理

### isPhase(phaseId)
**説明**: 現在のフェーズが指定したIDと同じかを確認します。  
**アクセス**: public  
**パラメータ**:
- phaseId: 確認するフェーズID  
**戻り値**: 現在のフェーズが指定したIDと同じ場合にtrue  
**処理内容**:
- ゲーム開始状態の確認
- フェーズIDの比較
- エラー処理

### handlePhaseStart(phase)
**説明**: フェーズ開始時の処理を行います。  
**アクセス**: private  
**パラメータ**:
- phase: 開始するフェーズ情報  
**処理内容**:
- フェーズに応じた固有処理の分岐
- 昼/投票/夜/ゲーム終了フェーズの開始処理

### handlePhaseEnd(phase)
**説明**: フェーズ終了時の処理を行います。  
**アクセス**: private  
**パラメータ**:
- phase: 終了するフェーズ情報  
**処理内容**:
- フェーズ終了イベントの発火
- フェーズに応じた固有処理の分岐

### handleDayPhaseStart()
**説明**: 昼フェーズ開始時の処理を行います。  
**アクセス**: private  
**処理内容**:
- 状態効果のクリア（護衛など）
- 初日処刑なしの場合の処理

### handleVotePhaseStart()
**説明**: 投票フェーズ開始時の処理を行います。  
**アクセス**: private  
**処理内容**:
- 投票マネージャーの設定

### handleNightPhaseStart()
**説明**: 夜フェーズ開始時の処理を行います。  
**アクセス**: private  
**処理内容**:
- アクションマネージャーの設定
- 初日占いルールの適用

### handleGameEndPhaseStart()
**説明**: ゲーム終了フェーズ開始時の処理を行います。  
**アクセス**: private  
**処理内容**:
- ゲーム終了状態への更新
- 勝者情報の取得と設定
- ゲーム終了イベントの発火

### applyFirstNightFortuneRule()
**説明**: 初日占いルールを適用します。  
**アクセス**: private  
**処理内容**:
- レギュレーションに基づく初日占いルールの適用
- ランダム白/ランダム/自由占いの処理

### setTurn(turn)
**説明**: ターンを強制的に設定します（主にテスト用）。  
**アクセス**: public  
**パラメータ**:
- turn: 設定するターン数  
**戻り値**: 設定成功時にtrue  
**処理内容**:
- ゲーム開始状態の確認
- ターン数のバリデーション
- ターン設定
- イベント発火
- エラー処理

## 設計上の注意点

1. **フェーズ遷移の管理**
   - 適切なタイミングでのフェーズ遷移
   - 各フェーズの開始と終了時の処理分担

2. **ターン管理と昼夜サイクル**
   - ターン数の適切な進行
   - 昼と夜のサイクルの追跡

3. **レギュレーションの適用**
   - 初日処刑なしなどの特殊ルールの適用
   - 初日占いルールの適用

4. **イベント駆動アーキテクチャ**
   - フェーズ遷移時のイベント発火
   - フェーズ固有のイベントの提供

5. **エラー処理**
   - フェーズ遷移時のエラーを適切に捕捉
   - ゲーム状態に基づく操作の妥当性検証

## イベントリスト

フェーズ管理に関連するイベント一覧：

| イベント名 | 発火タイミング | データ内容 |
|------------|----------------|------------|
| `game.start.before` | ゲーム開始処理前 | `{}` |
| `game.start.after` | ゲーム開始処理後 | `{playerCount, turn, phase}` |
| `phase.transition.before` | フェーズ遷移前 | `{fromPhase, toPhaseId, turn}` |
| `phase.transition.after` | フェーズ遷移後 | `{fromPhase, toPhase, turn}` |
| `phase.start.[phaseId]` | 各フェーズ開始時 | `{phase, turn}` |
| `phase.end.[phaseId]` | 各フェーズ終了時 | `{phase, turn}` |
| `turn.new` | 新しいターン開始時 | `{turn}` |
| `turn.set` | ターン設定時（テスト用） | `{turn, phase}` |
| `firstDay.noExecution` | 初日処刑なしルール適用時 | `{turn}` |
| `game.end` | ゲーム終了時 | `{winner, result, turn}` |

## 使用例

```
// ゲーム準備
game.addPlayer('プレイヤー1');
game.addPlayer('プレイヤー2');
game.addPlayer('プレイヤー3');
game.setRoles(['villager', 'werewolf', 'seer']);
game.distributeRoles();

// ゲーム開始
game.start();
console.log(game.getCurrentPhase().id); // 'day'（または初期フェーズ）

// フェーズ進行
game.nextPhase();
console.log(game.getCurrentPhase().id); // 'vote'

// 投票フェーズの完了
// ...投票処理...

// 次のフェーズ（夜）への移行
game.nextPhase();
console.log(game.getCurrentPhase().id); // 'night'
console.log(game.getCurrentTurn()); // 1

// 現在の昼夜サイクル確認
console.log(game.getDayNightCycle()); // 'night'

// 特定フェーズへの直接移行（テスト用）
game.moveToPhase('day');
console.log(game.getCurrentPhase().id); // 'day'
```
